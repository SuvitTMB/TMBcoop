<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - ระบบบริหารจัดการงานประชุม</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Google Font (Sarabun) -->
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;700&display=swap" rel="stylesheet">

    <!-- Confetti -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body { font-family: 'Sarabun', sans-serif; }
        .hidden { display: none !important; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        .fade-in-up { animation: fadeInUp 0.5s ease-out forwards; }
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .pop-in { animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        @keyframes popIn {
            from { opacity: 0; transform: scale(0.5); }
            to { opacity: 1; transform: scale(1); }
        }

        /* Lightbox/Modal Backdrop */
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
        }

        /* Toast Animation */
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .toast-enter { animation: slideInRight 0.3s ease-out forwards; }
        
        /* Table Styles: Height 32px, Zebra Striping, and text-sm */
        .table-compact thead tr {
            height: 32px;
        }
        .table-compact tbody tr {
            height: 32px;
            font-size: 0.875rem; /* text-sm */
        }
        .table-compact tbody tr:nth-child(even) {
            background-color: #f8fafc; /* Light Gray (slate-50) */
        }
        .table-compact tbody tr:nth-child(odd) {
            background-color: #ffffff; /* White */
        }
        .table-compact td, .table-compact th {
            padding-top: 0 !important;
            padding-bottom: 0 !important;
            vertical-align: middle;
        }

        /* Custom Scroll for Dark Area */
        .custom-scroll-dark::-webkit-scrollbar { width: 6px; }
        .custom-scroll-dark::-webkit-scrollbar-track { background: rgba(255,255,255,0.1); }
        .custom-scroll-dark::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.3); border-radius: 3px; }
        
        /* Winner Card Animation */
        @keyframes cardSlideIn {
            from { opacity: 0; transform: translateY(20px) scale(0.98); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        .winner-card-enter {
            animation: cardSlideIn 0.4s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
        }

        /* Sortable table headers */
        .sortable-header { cursor: pointer; user-select: none; }
        .sortable-header:hover { background-color: rgba(0,0,0,0.05); }
    </style>
</head>
<body class="bg-slate-100 min-h-screen flex flex-col md:flex-row overflow-hidden">

    <!-- Toast Container -->
    <div id="toast-container" class="fixed top-6 right-6 z-50 flex flex-col gap-3 w-80 pointer-events-none"></div>

    <!-- Sidebar -->
    <aside class="w-full md:w-64 bg-slate-800 text-white flex-shrink-0 flex flex-col h-screen overflow-y-auto z-20 shadow-xl">
        <div class="p-6 border-b border-slate-700 flex items-center gap-3">
            <div class="bg-blue-500 p-2 rounded-lg">
                <i data-lucide="layout-dashboard" width="24" height="24"></i>
            </div>
            <div>
                <h1 class="font-bold text-lg">Coop Admin</h1>
                <p class="text-xs text-slate-400">ระบบจัดการงานประชุม</p>
            </div>
        </div>
        
        <nav class="flex-1 p-4 space-y-2 overflow-y-auto">
            <button onclick="window.app.switchTab('dashboard')" id="nav-dashboard" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-slate-400 hover:bg-slate-700/50 hover:text-white transition-all">
                <i data-lucide="pie-chart" width="20"></i> ภาพรวม (Dashboard)
            </button>
            <button onclick="window.app.switchTab('prizes')" id="nav-prizes" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-slate-400 hover:bg-slate-700/50 hover:text-white transition-all">
                <i data-lucide="gift" width="20"></i> จัดการของรางวัล
            </button>
            <button onclick="window.app.switchTab('randomizer')" id="nav-randomizer" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-slate-400 hover:bg-slate-700/50 hover:text-white transition-all">
                <i data-lucide="play-circle" width="20"></i> จับรางวัล (Randomizer)
            </button>
            <button onclick="window.app.switchTab('results')" id="nav-results" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-slate-400 hover:bg-slate-700/50 hover:text-white transition-all">
                <i data-lucide="list-checks" width="20"></i> ประกาศผลรางวัล
            </button>
            <button onclick="window.app.switchTab('data')" id="nav-data" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-slate-400 hover:bg-slate-700/50 hover:text-white transition-all">
                <i data-lucide="table" width="20"></i> ข้อมูลลงทะเบียน
            </button>
            <button onclick="window.app.switchTab('dividend-info')" id="nav-dividend-info" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-slate-400 hover:bg-slate-700/50 hover:text-white transition-all">
                <i data-lucide="badge-dollar-sign" width="20"></i> ข้อมูลปันผล
            </button>
            
            <div class="pt-4 mt-4 border-t border-slate-700">
                <p class="px-4 text-xs text-slate-500 mb-2 font-bold">QR Code Management</p>
                <button onclick="window.app.switchTab('qrcode-in')" id="nav-qrcode-in" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-slate-400 hover:bg-slate-700/50 hover:text-white transition-all">
                    <i data-lucide="qr-code" width="20"></i> QR Code ลงทะเบียน
                </button>
                <button onclick="window.app.switchTab('qrcode-out')" id="nav-qrcode-out" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-slate-400 hover:bg-slate-700/50 hover:text-white transition-all">
                    <i data-lucide="qr-code" width="20"></i> QR Code เงินปันผล
                </button>
            </div>

            <div class="pt-4 mt-4 border-t border-slate-700">
                <p class="px-4 text-xs text-slate-500 mb-2 font-bold">Management Info</p>
                <button onclick="window.app.switchTab('import')" id="nav-import" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-slate-400 hover:bg-slate-700/50 hover:text-white transition-all">
                    <i data-lucide="database" width="20"></i> จัดการข้อมูล (Import)
                </button>
                <button onclick="window.app.switchTab('dividend')" id="nav-dividend" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-slate-400 hover:bg-slate-700/50 hover:text-white transition-all">
                    <i data-lucide="wallet" width="20"></i> จัดการเงินปันผล
                </button>
            </div>
        </nav>

        <div class="p-4 border-t border-slate-700">
            <div class="bg-slate-900 rounded-xl p-4">
                <p class="text-xs text-slate-500 mb-1">สถานะระบบ</p>
                <div class="flex items-center gap-2">
                    <div id="status-indicator" class="w-2 h-2 bg-red-500 rounded-full"></div>
                    <span id="status-text" class="text-sm text-slate-400">Connecting...</span>
                </div>
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col h-screen overflow-hidden relative">
        <!-- Top Bar -->
        <header class="bg-white border-b border-slate-200 h-16 flex items-center justify-between px-6 shadow-sm z-10">
            <h2 id="page-title" class="text-xl font-bold text-slate-800">ภาพรวม (Dashboard)</h2>
            <div class="flex items-center gap-4">
                <div class="text-right hidden sm:block">
                    <p class="text-sm font-bold text-slate-700">ผู้ดูแลระบบ</p>
                    <p class="text-xs text-slate-500" id="current-time">--:--:--</p>
                </div>
                <div class="w-10 h-10 bg-indigo-100 rounded-full flex items-center justify-center text-indigo-600 font-bold">
                    A
                </div>
            </div>
        </header>

        <!-- Content Area -->
        <div class="flex-1 overflow-y-auto p-6 bg-slate-50 relative" id="main-scroll">
            
            <!-- VIEW 1: DASHBOARD OVERVIEW -->
            <div id="view-dashboard" class="view-section hidden space-y-6 fade-in-up">
                <!-- Stats Cards -->
                <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-4">
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 flex flex-col relative overflow-hidden group">
                        <div class="absolute right-0 top-0 p-4 opacity-10">
                            <i data-lucide="users" width="60" height="60" class="text-blue-600"></i>
                        </div>
                        <p class="text-slate-500 text-sm font-medium">ลงทะเบียนเข้า</p>
                        <h3 id="stat-checkin" class="text-2xl font-bold text-slate-800 mt-2">0</h3>
                        <p class="text-green-500 text-xs mt-2 flex items-center gap-1"><i data-lucide="arrow-up" width="12"></i> Update Real-time</p>
                    </div>

                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 flex flex-col relative overflow-hidden group">
                        <div class="absolute right-0 top-0 p-4 opacity-10">
                            <i data-lucide="log-out" width="60" height="60" class="text-orange-600"></i>
                        </div>
                        <p class="text-slate-500 text-sm font-medium">ลงทะเบียนออก</p>
                        <h3 id="stat-checkout" class="text-2xl font-bold text-slate-800 mt-2">0</h3>
                        <div class="w-full bg-orange-100 rounded-full h-1.5 mt-3">
                            <div id="bar-checkout" class="bg-orange-500 h-1.5 rounded-full" style="width: 0%"></div>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 flex flex-col relative overflow-hidden group">
                        <div class="absolute right-0 top-0 p-4 opacity-10">
                            <i data-lucide="frown" width="60" height="60" class="text-slate-400"></i>
                        </div>
                        <p class="text-slate-500 text-sm font-medium">ผู้ไม่ได้รางวัล</p>
                        <h3 id="stat-noreward" class="text-2xl font-bold text-slate-800 mt-2">0</h3>
                        <p class="text-slate-400 text-xs mt-2">สุ่มแล้วไม่ได้รางวัล</p>
                    </div>

                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 flex flex-col relative overflow-hidden group">
                        <div class="absolute right-0 top-0 p-4 opacity-10">
                            <i data-lucide="gift" width="60" height="60" class="text-purple-600"></i>
                        </div>
                        <p class="text-slate-500 text-sm font-medium">ได้รับรางวัลแล้ว</p>
                        <h3 id="stat-rewarded" class="text-2xl font-bold text-slate-800 mt-2">0</h3>
                        <p id="stat-eligible" class="text-slate-400 text-xs mt-2">สุ่มและได้รางวัล</p>
                    </div>

                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 flex flex-col relative overflow-hidden group">
                        <div class="absolute right-0 top-0 p-4 opacity-10">
                            <i data-lucide="check-square" width="60" height="60" class="text-green-600"></i>
                        </div>
                        <p class="text-slate-500 text-sm font-medium">ยืนยันรับรางวัลแล้ว</p>
                        <h3 id="stat-claimed" class="text-2xl font-bold text-slate-800 mt-2">0</h3>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 items-stretch">
                    <div class="lg:col-span-2 space-y-6">
                        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="font-bold text-lg text-slate-700 flex items-center gap-2">
                                    <div class="w-3 h-3 bg-indigo-500 rounded-full"></div> สถิติการลงทะเบียนเข้า (Check-IN)
                                </h3>
                                <span class="text-2xl font-bold text-indigo-600" id="chart-total-checkin">0</span>
                            </div>
                            <div class="h-64">
                                <canvas id="registrationChart"></canvas>
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="font-bold text-lg text-slate-700 flex items-center gap-2">
                                    <div class="w-3 h-3 bg-orange-500 rounded-full"></div> สถิติการลงทะเบียนออก (Check-OUT)
                                </h3>
                                <span class="text-2xl font-bold text-orange-600" id="chart-total-checkout">0</span>
                            </div>
                            <div class="h-64">
                                <canvas id="checkoutChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 flex flex-col h-full max-h-[730px]"> 
                        <h3 class="font-bold text-lg text-slate-700 mb-4">กิจกรรมล่าสุด</h3>
                        <div id="recent-activity-list" class="space-y-4 overflow-y-auto pr-2 flex-1">
                            <div class="text-center text-slate-400 text-sm py-8">รอข้อมูล...</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- VIEW 2: PRIZE MANAGEMENT -->
            <div id="view-prizes" class="view-section hidden space-y-6 fade-in-up">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                        <h3 class="font-bold text-lg text-slate-800 mb-4 flex items-center gap-2">
                            <i data-lucide="plus-circle" width="20" class="text-indigo-600"></i> เพิ่ม/แก้ไข ของรางวัล
                        </h3>
                        <form id="prize-form" onsubmit="window.app.handlePrizeSubmit(event)" class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-slate-600 mb-1">ชื่อของรางวัล</label>
                                <input type="text" id="prize-name" required class="w-full p-3 border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-200 outline-none text-sm">
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-slate-600 mb-1">รางวัลที่จะสุ่ม (ต่อรอบ)</label>
                                    <input type="number" id="prize-qty" value="1" min="1" required class="w-full p-3 border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-200 outline-none text-sm">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-600 mb-1">จำนวนสิทธิ์ทั้งหมด</label>
                                    <input type="number" id="prize-total" value="1" min="1" required class="w-full p-3 border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-200 outline-none text-sm">
                                </div>
                            </div>
                            <button type="submit" class="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold hover:bg-indigo-700 transition">บันทึกข้อมูล</button>
                        </form>
                    </div>

                    <div class="lg:col-span-2 bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                        <h3 class="font-bold text-lg text-slate-800 mb-4">รายการของรางวัลทั้งหมด</h3>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left table-compact">
                                <thead class="bg-slate-200 text-slate-700 font-bold">
                                    <tr>
                                        <th class="px-4 py-3 rounded-l-lg">ชื่อของรางวัล</th>
                                        <th class="px-4 py-3 text-center">รางวัลที่จะสุ่ม</th>
                                        <th class="px-4 py-3 text-center">คงเหลือ / ทั้งหมด</th>
                                        <th class="px-4 py-3 text-right rounded-r-lg">จัดการ</th>
                                    </tr>
                                </thead>
                                <tbody id="prize-list-body" class="divide-y divide-slate-100">
                                    <tr><td colspan="4" class="text-center py-4 text-slate-400">กำลังโหลด...</td></tr>
                                </tbody>
                                <tfoot class="bg-slate-100 font-bold text-slate-700">
                                    <tr>
                                        <td class="px-4 py-3 text-right" colspan="2">รวมสิทธิ์ทั้งหมด:</td>
                                        <td class="px-4 py-3 text-center text-indigo-600" id="total-prize-quota">0</td>
                                        <td></td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- VIEW 3: RANDOMIZER SYSTEM -->
            <div id="view-randomizer" class="view-section hidden space-y-6">
                 <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-6">
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-100 border-l-4 border-blue-500">
                        <p class="text-slate-500 text-xs font-medium">ผู้ลงทะเบียนทั้งหมด</p>
                        <h3 id="rand-stat-total" class="text-2xl font-bold text-slate-800 mt-1">0</h3>
                    </div>
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-100 border-l-4 border-indigo-500">
                        <p class="text-slate-500 text-xs font-medium">ผู้มีสิทธิ์สุ่มรางวัล</p>
                        <h3 id="rand-stat-eligible-view" class="text-2xl font-bold text-slate-800 mt-1">0</h3>
                    </div>
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-100 border-l-4 border-slate-400">
                        <p class="text-slate-500 text-xs font-medium">ยังไม่ได้สุ่ม</p>
                        <h3 id="rand-stat-noreward" class="text-2xl font-bold text-slate-800 mt-1">0</h3>
                    </div>
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-100 border-l-4 border-red-500">
                        <p class="text-slate-500 text-xs font-medium">สุ่มแล้วไม่ได้รางวัล</p>
                        <h3 id="rand-stat-rewarded" class="text-2xl font-bold text-slate-800 mt-1">0</h3>
                    </div>
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-100 border-l-4 border-green-500">
                        <p class="text-slate-500 text-xs font-medium">สุ่มแล้วได้รางวัล</p>
                        <h3 id="rand-stat-claimed" class="text-2xl font-bold text-slate-800 mt-1">0</h3>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 h-full">
                    <div class="lg:col-span-4 space-y-6">
                        <div class="bg-white p-6 rounded-2xl shadow-md border border-slate-100">
                            <h3 class="font-bold text-lg text-slate-800 mb-4 flex items-center gap-2">
                                <div class="bg-indigo-100 p-2 rounded-lg text-indigo-600"><i data-lucide="settings-2" width="20"></i></div>
                                ตั้งค่าการสุ่ม
                            </h3>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-slate-600 mb-1">เลือกของรางวัล</label>
                                    <select id="select-prize" onchange="window.app.onPrizeSelect()" class="w-full p-3 border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-200 outline-none bg-white text-sm">
                                        <option value="">-- กรุณาเลือก --</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-600 mb-1">จำนวนผู้โชคดี (คน)</label>
                                    <div class="flex items-center gap-4">
                                        <input type="number" id="input-draw-qty" value="1" min="1" max="50" oninput="window.app.validateRandomizerInput()" class="w-full p-3 border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-200 outline-none font-mono text-center text-lg">
                                        <span class="text-slate-400 text-sm whitespace-nowrap">คน / รอบ</span>
                                    </div>
                                    <p class="text-xs text-orange-500 mt-1 hidden" id="qty-warning">จำนวนสุ่มเกินกว่าของรางวัลที่เหลือ!</p>
                                </div>
                                <div class="bg-slate-50 p-4 rounded-xl border border-slate-200">
                                    <div class="flex justify-between items-center mb-1">
                                        <span class="text-sm text-slate-500">คงเหลือในสต็อก</span>
                                        <span id="label-stock-count" class="font-bold text-orange-600 text-lg">0</span>
                                    </div>
                                     <div class="flex justify-between items-center mb-1">
                                        <span class="text-sm text-slate-500">ผู้มีสิทธิ์ลุ้นรางวัล</span>
                                        <span id="label-eligible-count" class="font-bold text-indigo-600 text-lg">0</span>
                                    </div>
                                    <div class="w-full bg-slate-200 rounded-full h-1.5">
                                        <div class="bg-indigo-500 h-1.5 rounded-full" style="width: 100%"></div>
                                    </div>
                                    <p class="text-xs text-slate-400 mt-2">*เฉพาะผู้ที่สถานะไม่ว่างและยังไม่เคยได้รางวัล</p>
                                </div>
                                <button onclick="window.app.startRandomizer()" id="btn-start-random" disabled class="w-full py-4 bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white rounded-xl font-bold shadow-lg shadow-indigo-200 transition-all transform active:scale-95 flex items-center justify-center gap-2 text-lg opacity-50 cursor-not-allowed">
                                    <i data-lucide="play" width="24" class="fill-current"></i> เริ่มสุ่มรางวัล
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="lg:col-span-8">
                        <div class="bg-gradient-to-br from-slate-900 via-blue-900 to-slate-900 rounded-3xl h-[650px] p-8 flex flex-col relative overflow-hidden shadow-2xl border border-slate-700/50">
                            <div class="relative z-10 flex justify-between items-start mb-8 border-b border-white/10 pb-4">
                                <div>
                                    <h1 id="screen-prize-title" class="text-xg font-bold text-transparent bg-clip-text bg-gradient-to-r from-yellow-200 via-yellow-400 to-yellow-200 drop-shadow-md">
                                        ระบบสุ่มรางวัล
                                    </h1>
                                </div>
                            </div>
                            <div id="screen-display-area" class="relative z-10 flex-1 grid grid-cols-1 content-start gap-4 overflow-y-auto custom-scroll-dark px-2 pb-4">
                                <div class="text-center text-slate-500/50 flex flex-col items-center justify-center h-full">
                                    <div class="w-24 h-24 bg-white/5 rounded-full flex items-center justify-center mb-4 backdrop-blur-sm">
                                        <i data-lucide="gift" width="40" height="40" class="text-white/20"></i>
                                    </div>
                                    <p class="text-white/40 font-light text-xm">พร้อมสำหรับการจับรางวัล</p>
                                </div>
                            </div>
                            <div id="screen-overlay-controls" class="hidden absolute inset-0 bg-black/80 backdrop-blur-sm z-20 flex items-center justify-center">
                                <div class="text-white text-center">
                                    <div class="w-16 h-16 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mb-6 mx-auto"></div>
                                    <h2 class="text-2xl font-bold tracking-tight">กำลังประมวลผล...</h2>
                                    <p class="text-blue-300 mt-2">กรุณารอสักครู่</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- VIEW 4: LIVE RESULTS -->
            <div id="view-results" class="view-section hidden space-y-6 fade-in-up">
                 <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4">
                    <div class="bg-gradient-to-br from-gray-600 to-gray-700 p-4 rounded-xl shadow-lg text-white">
                        <p class="text-gray-200 text-xs">สมาชิกทั้งหมดในระบบ</p>
                        <h3 id="monitor-total-db" class="text-2xl font-bold mt-1">0</h3>
                    </div>
                    <div class="bg-gradient-to-br from-blue-500 to-blue-600 p-4 rounded-xl shadow-lg text-white">
                        <p class="text-blue-100 text-xs">สมาชิกที่ลงทะเบียน (Active)</p>
                        <h3 id="monitor-registered" class="text-2xl font-bold mt-1">0</h3>
                    </div>
                    <div class="bg-gradient-to-br from-purple-500 to-purple-600 p-4 rounded-xl shadow-lg text-white">
                        <p class="text-purple-100 text-xs">จำนวนรางวัลที่แจกแล้ว</p>
                        <h3 id="monitor-draws" class="text-2xl font-bold mt-1">0</h3>
                    </div>
                    <div class="bg-gradient-to-br from-green-500 to-green-600 p-4 rounded-xl shadow-lg text-white">
                        <p class="text-green-100 text-xs">สมาชิกที่ได้รางวัลแล้ว</p>
                        <h3 id="monitor-rewarded" class="text-2xl font-bold mt-1">0</h3>
                    </div>
                    <div class="bg-gradient-to-br from-slate-500 to-slate-600 p-4 rounded-xl shadow-lg text-white">
                        <p class="text-slate-200 text-xs">สมาชิกที่ไม่ได้รางวัล</p>
                        <h3 id="monitor-noreward" class="text-2xl font-bold mt-1">0</h3>
                    </div>
                </div>
                <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
                    <div class="p-6 border-b border-slate-100 bg-slate-200 flex justify-between items-center">
                        <h3 class="font-bold text-lg text-slate-800">รายการผู้โชคดี (Real-time)</h3>
                        <select id="filter-results-status" onchange="window.app.renderResults()" class="bg-white border border-slate-300 text-slate-600 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2">
                            <option value="all_winners">ผู้ได้รับรางวัลทั้งหมด</option>
                            <option value="unclaimed">ผู้ที่ยังไม่รับรางวัล</option>
                            <option value="claimed">ผู้ที่รับรางวัลแล้ว</option>
                            <option value="no_reward">ผู้ที่ไม่ได้รับรางวัล</option>
                        </select>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left table-compact">
                            <thead class="bg-slate-200 text-slate-700 font-bold border-b border-slate-100">
                                <tr>
                                    <th class="px-6 py-4">ลำดับ</th>
                                    <th class="px-6 py-4">ชื่อ-นามสกุล</th>
                                    <th class="px-6 py-4">รางวัลที่ได้</th>
                                    <th class="px-6 py-4">เวลาที่สุ่มได้</th>
                                    <th class="px-6 py-4">สถานะการรับรางวัล</th>
                                    <th class="px-6 py-4 text-right">จัดการ</th>
                                </tr>
                            </thead>
                            <tbody id="results-table-body" class="divide-y divide-slate-100"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- VIEW 5: DATA TABLE (REGISTRATION) -->
            <div id="view-data" class="view-section hidden space-y-6 fade-in-up">
                 
                 <!-- Search Member Row (New Added) -->
                 <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                    <label class="block text-sm font-medium text-slate-600 mb-2">ค้นหาชื่อสมาชิกเพื่อลงทะเบียน (Real-time)</label>
                    <div class="flex gap-4 w-full md:w-1/2">
                        <input type="text" id="member-search-input" oninput="window.app.validateMemberSearch()" placeholder="ใส่ชื่อหรือรหัสสมาชิก..." class="flex-1 p-2.5 border border-slate-200 rounded-xl outline-none focus:ring-2 focus:ring-indigo-100 text-sm">
                        <button id="member-search-btn" onclick="window.app.openMemberSearchModal()" disabled class="px-6 py-2.5 bg-indigo-600 text-white rounded-xl font-bold opacity-50 cursor-not-allowed transition hover:bg-indigo-700 text-sm flex items-center gap-2">
                            <i data-lucide="search" width="16"></i> ค้นหา
                        </button>
                    </div>
                </div>

                 <!-- Summary Boxes Above Table -->
                 <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-100 flex items-center gap-4">
                        <div class="p-3 bg-blue-100 text-blue-600 rounded-lg"><i data-lucide="users" width="20"></i></div>
                        <div>
                            <p class="text-xs text-slate-500 font-medium">จำนวนสมาชิก</p>
                            <h3 id="reg-summary-total" class="text-xl font-bold text-slate-800">0</h3>
                        </div>
                    </div>
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-100 flex items-center gap-4">
                        <div class="p-3 bg-green-100 text-green-600 rounded-lg"><i data-lucide="check-circle" width="20"></i></div>
                        <div>
                            <p class="text-xs text-slate-500 font-medium">ลงทะเบียนแล้ว</p>
                            <h3 id="reg-summary-registered" class="text-xl font-bold text-green-600">0</h3>
                        </div>
                    </div>
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-100 flex items-center gap-4">
                        <div class="p-3 bg-purple-100 text-purple-600 rounded-lg"><i data-lucide="gift" width="20"></i></div>
                        <div>
                            <p class="text-xs text-slate-500 font-medium">ผู้รับรางวัล</p>
                            <h3 id="reg-summary-rewarded" class="text-xl font-bold text-purple-600">0</h3>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
                    <div class="p-6 border-b border-slate-100 flex flex-col md:flex-row justify-between items-center bg-slate-200 gap-4">
                        <h3 class="font-bold text-lg text-slate-800">ข้อมูลการลงทะเบียนทั้งหมด</h3>
                        <div class="flex items-center gap-2 flex-wrap justify-end">
                             <select id="sort-by" onchange="window.app.changeSort(this.value)" class="bg-slate-50 border border-slate-200 text-slate-600 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2">
                                <option value="EmpMember">เรียงตาม no</option>
                                <option value="EmpName">เรียงตามชื่อ-นามสกุล</option>
                                <option value="CheckIN">เรียงตาม Check-In</option>
                                <option value="reward">เรียงตามของรางวัล</option>
                             </select>
                             <select id="sort-order" onchange="window.app.changeSortOrder(this.value)" class="bg-slate-50 border border-slate-200 text-slate-600 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2">
                                <option value="desc">มาก -> น้อย (ล่าสุด/Z-A)</option>
                                <option value="asc">น้อย -> มาก (เก่าสุด/A-Z)</option>
                             </select>
                             <select id="rows-per-page" onchange="window.app.changeRowsLimit(this.value)" class="bg-slate-50 border border-slate-200 text-slate-600 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2">
                                <option value="20">20 แถว</option>
                                <option value="50" selected>50 แถว</option>
                                <option value="100">100 แถว</option>
                                <option value="500">500 แถว</option>
                                <option value="99999">ทั้งหมด</option>
                             </select>
                             <input type="text" id="search-data" oninput="window.app.handleSearch(this.value)" placeholder="ค้นหาชื่อ..." class="px-4 py-2 border border-slate-200 rounded-lg text-sm outline-none focus:ring-2 focus:ring-blue-100">
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left table-compact">
                            <thead class="bg-slate-200 text-slate-700 font-bold border-b border-slate-100">
                                <tr>
                                    <th class="px-6 py-2 text-center sortable-header" onclick="window.app.changeSort('EmpMember')">
                                        no <span id="reg-sort-EmpMember"></span>
                                    </th>
                                    <th class="px-6 py-2 sortable-header" onclick="window.app.changeSort('EmpName')">
                                        ชื่อ-นามสกุล (EmpName) <span id="reg-sort-EmpName"></span>
                                    </th>
                                    <th class="px-6 py-2 sortable-header" onclick="window.app.changeSort('CheckIN')">
                                        Check-In <span id="reg-sort-CheckIN"></span>
                                    </th>
                                    <th class="px-6 py-2 sortable-header" onclick="window.app.changeSort('reward')">
                                        ของรางวัล <span id="reg-sort-reward"></span>
                                    </th>
                                    <th class="px-6 py-2">สถานะรับรางวัล</th>
                                    <th class="px-6 py-2 text-right">จัดการ</th>
                                </tr>
                            </thead>
                            <tbody id="table-body" class="divide-y divide-slate-100"></tbody>
                        </table>
                        <div class="p-4 border-t border-slate-100 bg-slate-50 flex flex-col sm:flex-row justify-between items-center gap-4">
                            <div class="flex items-center gap-4">
                                <p class="text-xs text-slate-400 font-medium" id="data-table-info">แสดงผล...</p>
                                <button onclick="window.app.downloadRegistrationCSV()" class="px-4 py-1.5 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg text-xs font-bold transition flex items-center gap-2 shadow-sm">
                                    <i data-lucide="download" width="14"></i> Download CSV File
                                </button>
                            </div>
                            <div class="flex gap-2" id="pagination-controls">
                                <button onclick="window.app.changePage(-1)" class="px-3 py-1 bg-white border border-slate-300 rounded-md hover:bg-slate-50 disabled:opacity-50 text-xs" id="btn-prev">Previous</button>
                                <span class="text-xs self-center font-bold text-slate-600" id="page-indicator">Page 1</span>
                                <button onclick="window.app.changePage(1)" class="px-3 py-1 bg-white border border-slate-300 rounded-md hover:bg-slate-50 disabled:opacity-50 text-xs" id="btn-next">Next</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- VIEW 10: DIVIDEND INFO TABLE -->
            <div id="view-dividend-info" class="view-section hidden space-y-6 fade-in-up">
                 <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 flex flex-col relative overflow-hidden group">
                        <div class="absolute right-0 top-0 p-4 opacity-10">
                            <i data-lucide="users" width="60" height="60" class="text-indigo-600"></i>
                        </div>
                        <p class="text-slate-500 text-sm font-medium">สมาชิกปันผลทั้งหมด</p>
                        <h3 id="div-stat-total" class="text-2xl font-bold text-slate-800 mt-2">0</h3>
                    </div>
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 flex flex-col relative overflow-hidden group">
                        <div class="absolute right-0 top-0 p-4 opacity-10">
                            <i data-lucide="check-circle" width="60" height="60" class="text-green-600"></i>
                        </div>
                        <p class="text-slate-500 text-sm font-medium">ลงทะเบียนแล้ว</p>
                        <h3 id="div-stat-registered" class="text-2xl font-bold text-green-600 mt-2">0</h3>
                    </div>
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 flex flex-col relative overflow-hidden group">
                        <div class="absolute right-0 top-0 p-4 opacity-10">
                            <i data-lucide="presentation" width="60" height="60" class="text-blue-600"></i>
                        </div>
                        <p class="text-slate-500 text-sm font-medium">เข้าร่วมประชุมแล้ว</p>
                        <h3 id="div-stat-meeting" class="text-2xl font-bold text-blue-600 mt-2">0</h3>
                    </div>
                </div>

                <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
                    <div class="p-6 border-b border-slate-100 flex flex-col md:flex-row justify-between items-center bg-slate-200 gap-4">
                        <h3 class="font-bold text-lg text-slate-800">ข้อมูลสมาชิกปันผล</h3>
                        <div class="flex items-center gap-2 flex-wrap justify-end">
                             <input type="text" id="search-dividend" oninput="window.app.handleDividendSearch(this.value)" placeholder="ค้นหารหัส หรือ ชื่อ..." class="px-4 py-2 border border-slate-200 rounded-lg text-sm outline-none focus:ring-2 focus:ring-indigo-100 w-full md:w-64">
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left table-compact">
                            <thead class="bg-slate-200 text-slate-700 font-bold border-b border-slate-100">
                                <tr>
                                    <th class="px-4 py-3 text-center sortable-header text-sm" onclick="window.app.changeDivSort('no')">
                                        ลำดับ <span id="sort-icon-no"></span>
                                    </th>
                                    <th class="px-4 py-3 sortable-header text-sm" onclick="window.app.changeDivSort('empname')">
                                        ชื่อ-นามสกุล <span id="sort-icon-empname"></span>
                                    </th>
                                    <th class="px-4 py-3 text-right sortable-header text-sm" onclick="window.app.changeDivSort('dividend')">
                                        ปันผล <span id="sort-icon-dividend"></span>
                                    </th>
                                    <th class="px-4 py-3 text-right sortable-header text-sm" onclick="window.app.changeDivSort('moneyback')">
                                        เงินเฉลี่ยคืน <span id="sort-icon-moneyback"></span>
                                    </th>
                                    <th class="px-4 py-3 text-right sortable-header text-sm" onclick="window.app.changeDivSort('gratuity')">
                                        ค่าของขวัญ <span id="sort-icon-gratuity"></span>
                                    </th>
                                    <th class="px-4 py-3 text-right sortable-header text-sm" onclick="window.app.changeDivSort('netpayment')">
                                        รับสุทธิ <span id="sort-icon-netpayment"></span>
                                    </th>
                                    <th class="px-4 py-3 sortable-header text-sm" onclick="window.app.changeDivSort('DateLogin')">
                                        ลงทะเบียน <span id="sort-icon-DateLogin"></span>
                                    </th>
                                    <th class="px-4 py-3 sortable-header text-sm" onclick="window.app.changeDivSort('RegisMeeting')">
                                        เข้าประชุม <span id="sort-icon-RegisMeeting"></span>
                                    </th>
                                    <th class="px-4 py-3 text-right text-sm">จัดการ</th>
                                </tr>
                            </thead>
                            <tbody id="dividend-table-body" class="divide-y divide-slate-100">
                                <tr><td colspan="9" class="text-center py-8 text-slate-400">กำลังรอข้อมูล...</td></tr>
                            </tbody>
                        </table>
                        <div class="p-4 border-t border-slate-100 bg-slate-50 flex flex-col sm:flex-row justify-between items-center gap-4">
                            <div class="flex items-center gap-4">
                                <p class="text-xs text-slate-400 font-medium" id="div-table-info">แสดงผล...</p>
                                <button onclick="window.app.downloadDividendCSV()" class="px-4 py-1.5 bg-emerald-600 hover:bg-emerald-700 text-white rounded-lg text-xs font-bold transition flex items-center gap-2 shadow-sm">
                                    <i data-lucide="download" width="14"></i> Download CSV File
                                </button>
                            </div>
                            <div class="flex gap-2" id="div-pagination-controls">
                                <button onclick="window.app.changeDivPage(-1)" class="px-3 py-1 bg-white border border-slate-300 rounded-md hover:bg-slate-50 disabled:opacity-50 text-xs" id="btn-div-prev">Previous</button>
                                <span class="self-center font-bold text-slate-600 text-xs" id="div-page-indicator">Page 1</span>
                                <button onclick="window.app.changeDivPage(1)" class="px-3 py-1 bg-white border border-slate-300 rounded-md hover:bg-slate-50 disabled:opacity-50 text-xs" id="btn-div-next">Next</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- VIEW 6: IMPORT REGISTRATION DATA -->
            <div id="view-import" class="view-section hidden space-y-6 fade-in-up">
                 <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                        <h3 class="font-bold text-lg text-slate-800 mb-4 flex items-center gap-2">
                            <i data-lucide="upload-cloud" width="20" class="text-blue-600"></i> นำเข้าข้อมูลรายชื่อ (JSON/CSV)
                        </h3>
                        <p class="text-sm text-slate-500 mb-4">
                            รองรับไฟล์ที่มึคีย์ <code>citizenId</code> เพื่อใช้ทำ Hashing ก่อนบันทึกเข้าตารางหลัก
                        </p>
                        <div class="space-y-4">
                            <div class="border-2 border-dashed border-slate-200 rounded-xl p-8 text-center hover:bg-slate-50 transition cursor-pointer" onclick="document.getElementById('file-upload').click()">
                                <i data-lucide="file-up" width="40" class="mx-auto text-slate-400 mb-2"></i>
                                <p class="text-sm font-medium text-slate-600">คลิกเพื่อเลือกไฟล์ หรือลากไฟล์มาวางที่นี่</p>
                                <p class="text-xs text-slate-400 mt-1">รองรับ .json, .csv</p>
                                <input type="file" id="file-upload" class="hidden" accept=".json,.csv" onchange="window.app.handleFileSelect(event)">
                            </div>
                            <div id="file-info" class="hidden bg-blue-50 p-3 rounded-lg flex items-center justify-between text-sm text-blue-700">
                                <span id="file-name">filename.json</span>
                                <button onclick="window.app.clearFileSelection()" class="text-blue-500 hover:text-blue-700"><i data-lucide="x" width="16"></i></button>
                            </div>
                            <button onclick="window.app.processImport()" id="btn-import" disabled class="w-full bg-blue-600 text-white py-3 rounded-xl font-bold hover:bg-blue-700 transition disabled:opacity-50 disabled:cursor-not-allowed">
                                เริ่มนำเข้าข้อมูล
                            </button>
                            <div id="import-progress" class="hidden w-full bg-slate-200 rounded-full h-2.5">
                                <div id="import-bar" class="bg-blue-600 h-2.5 rounded-full" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                         <h3 class="font-bold text-lg text-slate-800 mb-4 flex items-center gap-2">
                            <i data-lucide="database" width="20" class="text-slate-600"></i> ข้อมูลระบบ
                        </h3>
                        <div class="bg-slate-50 p-4 rounded-xl mb-6 flex justify-between items-center">
                            <div>
                                <p class="text-sm text-slate-500">จำนวนข้อมูลรายชื่อทั้งหมด (Records)</p>
                                <h2 class="text-2xl font-bold text-slate-800 mt-1" id="manage-total-docs">0</h2>
                            </div>
                            <div class="bg-white p-3 rounded-full shadow-sm text-slate-400">
                                <i data-lucide="hard-drive" width="24"></i>
                            </div>
                        </div>
                        <div class="border-t border-slate-100 pt-6 space-y-4">
                            <h4 class="font-bold text-red-600 mb-2 flex items-center gap-2"><i data-lucide="alert-octagon" width="18"></i> Danger Zone</h4>
                             <div class="bg-orange-50 p-4 rounded-xl border border-orange-100">
                                <p class="text-sm font-bold text-orange-800 mb-1">รีเซ็ตการลงทะเบียน (Reset Status)</p>
                                <button onclick="window.app.openResetModal()" class="w-full border border-orange-300 text-orange-700 hover:bg-orange-100 py-2 rounded-lg font-bold transition flex items-center justify-center gap-2 text-sm">
                                    <i data-lucide="rotate-ccw" width="16"></i> รีเซ็ตสถานะรายชื่อ
                                </button>
                            </div>
                            <div class="bg-red-50 p-4 rounded-xl border border-red-100">
                                <p class="text-sm font-bold text-red-800 mb-1">ลบข้อมูลทั้งหมด (Delete All)</p>
                                <button onclick="window.app.deleteAllData()" class="w-full border border-red-300 text-red-700 hover:bg-red-100 py-2 rounded-lg font-bold transition flex items-center justify-center gap-2 text-sm">
                                    <i data-lucide="trash-2" width="16"></i> ลบฐานข้อมูลรายชื่อ
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- VIEW 9: MANAGE DIVIDEND (IMPORT) -->
            <div id="view-dividend" class="view-section hidden space-y-6 fade-in-up">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Upload Card -->
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                        <h3 class="font-bold text-lg text-slate-800 mb-4 flex items-center gap-2">
                            <i data-lucide="wallet" width="20" class="text-emerald-600"></i> นำเข้าข้อมูลเงินปันผล (JSON/CSV)
                        </h3>
                        <p class="text-sm text-slate-500 mb-4">
                            ระบบจะโหลดข้อมูลเข้าตาราง <code>tmb_coop_dividend</code> และกำหนดสถานะ <code>membertype: "member"</code> อัตโนมัติ
                        </p>
                        <div class="space-y-4">
                            <div class="border-2 border-dashed border-slate-200 rounded-xl p-8 text-center hover:bg-slate-50 transition cursor-pointer" onclick="document.getElementById('dividend-file-upload').click()">
                                <i data-lucide="file-up" width="40" class="mx-auto text-slate-400 mb-2"></i>
                                <p class="text-sm font-medium text-slate-600">คลิกเพื่อเลือกไฟล์ปันผล</p>
                                <p class="text-xs text-slate-400 mt-1">รองรับ .json, .csv</p>
                                <input type="file" id="dividend-file-upload" class="hidden" accept=".json,.csv" onchange="window.app.handleDividendFileSelect(event)">
                            </div>
                            <div id="dividend-file-info" class="hidden bg-emerald-50 p-3 rounded-lg flex items-center justify-between text-sm text-emerald-700">
                                <span id="dividend-file-name">filename.json</span>
                                <button onclick="window.app.clearDividendFileSelection()" class="text-emerald-500 hover:text-emerald-700"><i data-lucide="x" width="16"></i></button>
                            </div>
                            <button onclick="window.app.processDividendImport()" id="btn-dividend-import" disabled class="w-full bg-emerald-600 text-white py-3 rounded-xl font-bold hover:bg-emerald-700 transition disabled:opacity-50 disabled:cursor-not-allowed">
                                เริ่มนำเข้าข้อมูลปันผล
                            </button>
                            <div id="dividend-import-progress" class="hidden w-full bg-slate-200 rounded-full h-2.5">
                                <div id="dividend-import-bar" class="bg-emerald-600 h-2.5 rounded-full" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Stats Card -->
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                         <h3 class="font-bold text-lg text-slate-800 mb-4 flex items-center gap-2">
                            <i data-lucide="database" width="20" class="text-slate-600"></i> ข้อมูลเงินปันผล
                        </h3>
                        <div class="bg-slate-50 p-4 rounded-xl mb-6 flex justify-between items-center">
                            <div>
                                <p class="text-sm text-slate-500">จำนวนข้อมูลปันผลทั้งหมด (Records)</p>
                                <h2 class="text-2xl font-bold text-slate-800 mt-1" id="manage-dividend-total">0</h2>
                            </div>
                            <div class="bg-white p-3 rounded-full shadow-sm text-emerald-400">
                                <i data-lucide="banknote" width="24"></i>
                            </div>
                        </div>
                        <div class="border-t border-slate-100 pt-6 space-y-4">
                            <h4 class="font-bold text-red-600 mb-2 flex items-center gap-2"><i data-lucide="alert-octagon" width="18"></i> Danger Zone</h4>
                             <div class="bg-orange-50 p-4 rounded-xl border border-orange-100">
                                <p class="text-sm font-bold text-orange-800 mb-1">รีเซ็ตสถานะปันผล</p>
                                <button onclick="window.app.openDividendResetModal()" class="w-full border border-orange-300 text-orange-700 hover:bg-orange-100 py-2 rounded-lg font-bold transition flex items-center justify-center gap-2 text-sm">
                                    <i data-lucide="rotate-ccw" width="16"></i> รีเซ็ตการรับปันผลทั้งหมด
                                </button>
                            </div>
                            <div class="bg-red-50 p-4 rounded-xl border border-red-100">
                                <p class="text-sm font-bold text-red-800 mb-1">ลบข้อมูลปันผลทั้งหมด</p>
                                <button onclick="window.app.deleteAllDividendData()" class="w-full border border-red-300 text-red-700 hover:bg-red-100 py-2 rounded-lg font-bold transition flex items-center justify-center gap-2 text-sm">
                                    <i data-lucide="trash-2" width="16"></i> ล้างฐานข้อมูลปันผล
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- VIEW 7: QR Code CheckIN -->
            <div id="view-qrcode-in" class="view-section hidden space-y-6 fade-in-up">
                 <div class="bg-white p-10 rounded-2xl shadow-lg border border-slate-100 flex flex-col items-center justify-center text-center min-h-[60vh]">
                    <h2 class="text-2xl font-bold text-blue-800 mb-2">ลงทะเบียนเข้าประชุม</h2>
                    <p class="text-slate-500 mb-8">สแกน QR Code เพื่อลงทะเบียนเข้าร่วมงาน</p>
                    <div class="bg-white p-4 rounded-xl shadow-inner border border-slate-300 mb-6">
                        <img src="./images/Coop-login.png" onerror="this.src='https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=https://suvittmb.github.io/TMBcoop/coop-register.html'" alt="Check-IN QR Code" class="w-80 h-80 object-contain">
                    </div>
                    <p class="text-xs text-slate-400">URL: https://suvittmb.github.io/TMBcoop/coop-register.html</p>
                    <button class="mt-6 px-6 py-2 bg-slate-100 hover:bg-slate-200 text-slate-600 rounded-lg text-sm transition flex items-center gap-2">
                        <i data-lucide="printer" width="16"></i> พิมพ์หน้านี้
                    </button>
                </div>
            </div>

            <!-- VIEW 8: QR Code CheckOUT -->
            <div id="view-qrcode-out" class="view-section hidden space-y-6 fade-in-up">
                 <div class="bg-white p-10 rounded-2xl shadow-lg border border-slate-100 flex flex-col items-center justify-center text-center min-h-[60vh]">
                    <h2 class="text-2xl font-bold text-orange-600 mb-2">ลงทะเบียนเช็คเงินปันผล</h2>
                    <p class="text-slate-500 mb-8">สแกน QR Code เพื่อลงทะเบียนเช็คเงินปันผล</p>
                    <div class="bg-white p-4 rounded-xl shadow-inner border border-slate-300 mb-6">
                        <img src="./images/Coop-out.png" onerror="this.src='https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=https://suvittmb.github.io/TMBcoop/coop-dividend.html'" alt="Check-OUT QR Code" class="w-80 h-80 object-contain">
                    </div>
                    <p class="text-xs text-slate-400">URL: https://suvittmb.github.io/TMBcoop/coop-dividend.html</p>
                     <button class="mt-6 px-6 py-2 bg-slate-100 hover:bg-slate-200 text-slate-600 rounded-lg text-sm transition flex items-center gap-2">
                        <i data-lucide="printer" width="16"></i> พิมพ์หน้านี้
                    </button>
                </div>
            </div>

        </div>
    </main>

    <!-- Lightbox for Member Search Result (New Added) -->
    <div id="member-search-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-backdrop">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 transform transition-all scale-100 text-center">
            <div class="w-16 h-16 bg-indigo-100 rounded-full flex items-center justify-center mx-auto mb-4 text-indigo-600">
                <i data-lucide="user" width="32"></i>
            </div>
            <h3 class="text-xl font-bold text-slate-800 mb-2">ยืนยันข้อมูลสมาชิก</h3>
            <div id="search-member-details" class="text-left bg-slate-50 p-4 rounded-xl mb-6 space-y-2 text-sm">
                <!-- Data injected via JS -->
            </div>
            <div class="flex gap-3">
                <button onclick="window.app.closeMemberSearchModal()" class="flex-1 py-3 rounded-xl bg-slate-100 text-slate-600 font-bold hover:bg-slate-200 transition text-sm">ยกเลิก</button>
                <button id="btn-confirm-regis" onclick="window.app.confirmRegistrationViaSearch()" class="flex-1 py-3 rounded-xl bg-indigo-600 text-white font-bold hover:bg-indigo-700 transition text-sm">ลงทะเบียนสมาชิก</button>
            </div>
        </div>
    </div>

    <!-- Modal: Edit Prize -->
    <div id="edit-prize-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-backdrop">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 transform transition-all scale-100">
            <div class="flex justify-between items-center mb-4 border-b border-slate-100 pb-2">
                <h3 class="text-lg font-bold text-slate-800">แก้ไขของรางวัล</h3>
                <button onclick="window.app.closeEditPrizeModal()" class="text-slate-400 hover:text-slate-600">
                    <i data-lucide="x" width="24"></i>
                </button>
            </div>
            <form id="edit-prize-form" onsubmit="window.app.handlePrizeUpdate(event)" class="space-y-4">
                <input type="hidden" id="edit-prize-id">
                <div>
                    <label class="block text-sm font-medium text-slate-600 mb-1">ชื่อของรางวัล</label>
                    <input type="text" id="edit-prize-name" required class="w-full p-3 border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-200 outline-none text-sm">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-600 mb-1">รางวัลที่จะสุ่ม (ต่อรอบ)</label>
                        <input type="number" id="edit-prize-qty" min="1" required class="w-full p-3 border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-200 outline-none text-sm">
                    </div>
                     <div>
                        <label class="block text-sm font-medium text-slate-600 mb-1">จำนวนสิทธิ์ทั้งหมด</label>
                        <input type="number" id="edit-prize-total" min="1" required class="w-full p-3 border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-200 outline-none text-sm">
                    </div>
                </div>
                
                <div class="flex gap-3 pt-2">
                    <button type="button" onclick="window.app.closeEditPrizeModal()" class="flex-1 py-3 rounded-xl text-slate-600 bg-slate-100 hover:bg-slate-200 font-bold transition text-sm">ยกเลิก</button>
                    <button type="submit" class="flex-1 py-3 rounded-xl text-white bg-indigo-600 hover:bg-indigo-700 font-bold transition text-sm">บันทึก</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Dividend Reset Confirmation Modal -->
    <div id="dividend-reset-confirm-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-backdrop">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm p-6 transform transition-all scale-100 text-center">
            <div class="w-14 h-14 bg-orange-100 rounded-full flex items-center justify-center mx-auto mb-4 text-orange-600">
                <i data-lucide="rotate-ccw" width="32"></i>
            </div>
            <h3 class="text-xl font-bold text-slate-800 mb-2">รีเซ็ตข้อมูลเงินปันผล?</h3>
            <p class="text-slate-500 text-sm mb-6">ระบบจะล้างข้อมูล DateLogin, RegisMeeting, DateMeeting ทั้งหมดในตารางเงินปันผล</p>
            <div class="flex gap-3">
                <button onclick="window.app.closeDividendResetModal()" class="flex-1 py-3 rounded-xl bg-slate-100 text-slate-600 font-bold hover:bg-slate-200 transition text-sm">ยกเลิก</button>
                <button onclick="window.app.confirmResetDividendData()" class="flex-1 py-3 rounded-xl bg-orange-600 text-white font-bold hover:bg-orange-700 transition text-sm">ยืนยันรีเซ็ต</button>
            </div>
        </div>
    </div>

    <!-- General Modal -->
    <div id="general-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-backdrop">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm p-6 transform transition-all scale-100 text-center">
            <div class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4 text-red-500">
                <i data-lucide="alert-circle" width="24"></i>
            </div>
            <h3 id="general-modal-title" class="text-lg font-bold text-slate-800 mb-2">แจ้งเตือน</h3>
            <p id="general-modal-message" class="text-slate-500 text-sm mb-6">ข้อความแจ้งเตือน</p>
            <button onclick="window.app.closeGeneralModal()" class="w-full py-2.5 rounded-xl bg-slate-800 text-white font-bold hover:bg-slate-900 transition text-sm">ตกลง</button>
        </div>
    </div>

    <!-- Reset Confirmation Modal -->
    <div id="reset-confirm-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-backdrop">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm p-6 transform transition-all scale-100 text-center">
            <div class="w-14 h-14 bg-orange-100 rounded-full flex items-center justify-center mx-auto mb-4 text-orange-600">
                <i data-lucide="alert-triangle" width="32"></i>
            </div>
            <h3 class="text-xl font-bold text-slate-800 mb-2">ยืนยันการรีเซ็ต?</h3>
            <p class="text-slate-500 text-sm mb-6">
                ระบบจะล้างข้อมูลการลงทะเบียน (Check-In/Out) และประวัติการรับรางวัลทั้งหมด <br>
                <span class="font-bold text-orange-600">แต่จะเก็บรายชื่อพนักงานไว้</span>
            </p>
            <div class="flex gap-3">
                <button onclick="window.app.closeResetModal()" class="flex-1 py-3 rounded-xl bg-slate-100 text-slate-600 font-bold hover:bg-slate-200 transition text-sm">ยกเลิก</button>
                <button onclick="window.app.confirmResetData()" class="flex-1 py-3 rounded-xl bg-orange-600 text-white font-bold hover:bg-orange-700 transition text-sm">ยืนยันรีเซ็ต</button>
            </div>
        </div>
    </div>

    <!-- Firebase Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
        import { getFirestore, collection, query, where, getDocs, updateDoc, doc, serverTimestamp, onSnapshot, addDoc, deleteDoc, writeBatch, deleteField, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

        // Global environment variables
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const isSandboxEnv = typeof __firebase_config !== 'undefined';
        
        let firebaseConfig;
        let finalCollectionPath;
        let prizesCollectionPath;
        let dividendCollectionPath;

        if (isSandboxEnv) {
            firebaseConfig = JSON.parse(__firebase_config);
            finalCollectionPath = `artifacts/${appId}/public/data/coop_registrations`;
            prizesCollectionPath = `artifacts/${appId}/public/data/coop_gift`;
            dividendCollectionPath = `artifacts/${appId}/public/data/tmb_coop_dividend`;
        } else {
            // RESTORED ORIGINAL FIREBASE CONFIG
            firebaseConfig = {
                apiKey: "AIzaSyAgWMzWcZPzyzoBu5eQzj2y59nKsxTWurQ",
                authDomain: "ttb-register.firebaseapp.com",
                databaseURL: "https://ttb-register-default-rtdb.asia-southeast1.firebasedate.app",
                projectId: "ttb-register",
                storageBucket: "ttb-register.firebasestorage.app",
                messagingSenderId: "1070273157855",
                appId: "1:1070273157855:web:5c8120e1df27e233d8676a",
                measurementId: "G-9DJLWJ5LQ1"
            };
            finalCollectionPath = 'tmb_coop';
            prizesCollectionPath = 'coop_gift';
            dividendCollectionPath = 'tmb_coop_dividend';
        }

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const state = {
            users: [],
            dividendUsers: [],
            prizes: [],
            stats: { checkin: 0, checkout: 0, rewarded: 0, claimed: 0, eligible: 0, totalDocs: 0, registered: 0, notRewarded: 0, notYetDrawn: 0, drawnNoReward: 0, drawnWon: 0, dividendTotal: 0 },
            isDrawing: false,
            fileToImport: null,
            dividendFileToImport: null,
            rowsPerPage: 50,
            currentPage: 1,
            sortBy: 'EmpMember',
            sortOrder: 'asc',
            searchTerm: '',
            // State for Dividend Info Tab
            divCurrentPage: 1,
            divRowsPerPage: 50,
            divSearchTerm: '',
            divSortBy: 'no',
            divSortOrder: 'asc',
            // Rapid Search Candidate
            searchCandidate: null
        };

        async function sha256(message) {
            const msgBuffer = new TextEncoder().encode(message);
            const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }

        window.app = window.app || {};
        
        // --- TOASTS & MODALS ---
        window.app.showToast = (message, type = 'success') => {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            let bgClass, iconHtml;
            if(type === 'success') {
                bgClass = 'bg-white border-l-4 border-green-500 text-slate-700';
                iconHtml = '<div class="text-green-500"><i data-lucide="check-circle" width="20"></i></div>';
            } else if(type === 'error') {
                bgClass = 'bg-white border-l-4 border-red-500 text-slate-700';
                iconHtml = '<div class="text-red-500"><i data-lucide="alert-circle" width="20"></i></div>';
            } else {
                bgClass = 'bg-white border-l-4 border-blue-500 text-slate-700';
                iconHtml = '<div class="text-blue-500"><i data-lucide="info" width="20"></i></div>';
            }
            toast.className = `${bgClass} p-4 rounded-lg shadow-lg flex items-start gap-3 toast-enter pointer-events-auto transform transition-all duration-300`;
            toast.innerHTML = `${iconHtml}<div class="flex-1 text-sm font-medium">${message}</div><button onclick="this.parentElement.remove()" class="text-slate-400 hover:text-slate-600"><i data-lucide="x" width="16"></i></button>`;
            if (container) container.appendChild(toast);
            if(window.lucide) lucide.createIcons();
            setTimeout(() => { toast.classList.add('opacity-0', 'translate-x-full'); setTimeout(() => toast.remove(), 300); }, 3000);
        };

        window.app.showModal = (title, message) => {
             document.getElementById('general-modal-title').innerText = title;
             document.getElementById('general-modal-message').innerText = message;
             document.getElementById('general-modal').classList.remove('hidden');
        };
        window.app.closeGeneralModal = () => document.getElementById('general-modal').classList.add('hidden');
        window.app.openResetModal = () => document.getElementById('reset-confirm-modal').classList.remove('hidden');
        window.app.closeResetModal = () => document.getElementById('reset-confirm-modal').classList.add('hidden');
        window.app.openDividendResetModal = () => document.getElementById('dividend-reset-confirm-modal').classList.remove('hidden');
        window.app.closeDividendResetModal = () => document.getElementById('dividend-reset-confirm-modal').classList.add('hidden');

        // --- RAPID MEMBER SEARCH ---
        window.app.validateMemberSearch = () => {
            const inputVal = document.getElementById('member-search-input').value.trim().toLowerCase();
            const btn = document.getElementById('member-search-btn');
            if (!inputVal) {
                btn.disabled = true;
                btn.classList.add('opacity-50', 'cursor-not-allowed');
                state.searchCandidate = null;
                return;
            }

            const match = state.users.find(u => 
                (u.EmpName || '').toLowerCase().includes(inputVal) || 
                (u.EmpMember || '').toString().toLowerCase() === inputVal
            );

            if (match) {
                state.searchCandidate = match;
                btn.disabled = false;
                btn.classList.remove('opacity-50', 'cursor-not-allowed');
            } else {
                state.searchCandidate = null;
                btn.disabled = true;
                btn.classList.add('opacity-50', 'cursor-not-allowed');
            }
        };

        window.app.openMemberSearchModal = () => {
            const m = state.searchCandidate;
            if (!m) return;
            const details = document.getElementById('search-member-details');
            details.innerHTML = `
                <div class="grid grid-cols-3 gap-2">
                    <span class="text-slate-400">ชื่อ-นามสกุล:</span>
                    <span class="col-span-2 font-bold text-slate-800">${m.EmpName || '-'}</span>
                    <span class="text-slate-400">รหัสสมาชิก (no):</span>
                    <span class="col-span-2 font-mono">${m.EmpMember || '-'}</span>
                    <span class="text-slate-400">สถานะ:</span>
                    <span class="col-span-2">${m.CheckIN ? '<span class="text-green-600 font-bold">ลงทะเบียนแล้ว</span>' : '<span class="text-orange-500">ยังไม่ลงทะเบียน</span>'}</span>
                </div>
            `;
            
            const confirmBtn = document.getElementById('btn-confirm-regis');
            if (m.CheckIN) {
                confirmBtn.disabled = true;
                confirmBtn.classList.add('opacity-50', 'cursor-not-allowed');
            } else {
                confirmBtn.disabled = false;
                confirmBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            }

            document.getElementById('member-search-modal').classList.remove('hidden');
            if(window.lucide) lucide.createIcons();
        };

        window.app.closeMemberSearchModal = () => {
            document.getElementById('member-search-modal').classList.add('hidden');
        };

        window.app.confirmRegistrationViaSearch = async () => {
            const m = state.searchCandidate;
            if (!m || m.CheckIN) return;
            
            try {
                const ref = doc(db, finalCollectionPath, m.id);
                await updateDoc(ref, {
                    CheckIN: serverTimestamp(),
                    status: 'Active'
                });
                window.app.showToast(`ลงทะเบียนคุณ ${m.EmpName} สำเร็จ`, 'success');
                window.app.closeMemberSearchModal();
                document.getElementById('member-search-input').value = '';
                window.app.validateMemberSearch();
            } catch (e) {
                console.error(e);
                window.app.showToast("เกิดข้อผิดพลาดในการลงทะเบียน", 'error');
            }
        };

        // --- NAVIGATION ---
        window.app.switchTab = (tabName) => {
            document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
            const targetView = document.getElementById(`view-${tabName}`);
            if (targetView) targetView.classList.remove('hidden');
            
            document.querySelectorAll('.nav-item').forEach(el => { el.classList.remove('bg-slate-700', 'text-white'); el.classList.add('text-slate-400'); });
            const activeNav = document.getElementById(`nav-${tabName}`);
            if(activeNav) {
                activeNav.classList.remove('text-slate-400'); activeNav.classList.add('bg-slate-700', 'text-white');
            }
            let title = 'ภาพรวมระบบ';
            switch(tabName) {
                case 'randomizer': title = 'ระบบสุ่มรางวัล'; break;
                case 'prizes': title = 'จัดการของรางวัล'; break;
                case 'results': title = 'ประกาศผลรางวัล'; break;
                case 'data': title = 'ข้อมูลลงทะเบียน'; break;
                case 'dividend-info': title = 'ข้อมูลสมาชิกปันผล'; break;
                case 'import': title = 'จัดการข้อมูล (Import)'; break;
                case 'dividend': title = 'จัดการเงินปันผล (Import)'; break;
                case 'qrcode-in': title = 'QR Code CheckIN'; break;
                case 'qrcode-out': title = 'QR Code CheckOUT'; break;
            }
            document.getElementById('page-title').innerText = title;
            if(tabName === 'randomizer') window.app.onPrizeSelect();
            if(tabName === 'dividend-info') renderDividendTable(state.dividendUsers);
            if(tabName === 'data') renderTable(state.users);
        };

        // --- TABLES, PAGINATION & SORTING ---
        window.app.changeRowsLimit = (val) => { state.rowsPerPage = parseInt(val); state.currentPage = 1; renderTable(state.users); };
        window.app.changePage = (direction) => { state.currentPage += direction; renderTable(state.users); };
        window.app.changeSort = (val) => { 
            if (state.sortBy === val) {
                state.sortOrder = state.sortOrder === 'asc' ? 'desc' : 'asc';
            } else {
                state.sortBy = val;
                state.sortOrder = 'asc';
            }
            state.currentPage = 1; 
            renderTable(state.users); 
        };
        window.app.changeSortOrder = (val) => { state.sortOrder = val; state.currentPage = 1; renderTable(state.users); };
        window.app.handleSearch = (val) => { 
            state.searchTerm = val.trim().toLowerCase();
            state.currentPage = 1;
            renderTable(state.users);
        };

        function renderTable(users) {
            const tbody = document.getElementById('table-body');
            if(!tbody) return;
            const infoText = document.getElementById('data-table-info');
            
            let displayData = [...users];
            if (state.searchTerm) {
                displayData = users.filter(u => (u.EmpName || '').toLowerCase().includes(state.searchTerm) || (u.EmpMember || '').toString().toLowerCase().includes(state.searchTerm));
            }

            const sortedUsers = [...displayData].sort((a, b) => {
                const sortBy = state.sortBy || 'EmpMember';
                let valA = a[sortBy]; let valB = b[sortBy];
                
                if (valA === null || valA === undefined) valA = '';
                if (valB === null || valB === undefined) valB = '';

                if (sortBy === 'CheckIN') {
                    const timeA = valA ? (valA.toDate ? valA.toDate().getTime() : new Date(valA).getTime()) : 0;
                    const timeB = valB ? (valB.toDate ? valB.toDate().getTime() : new Date(valB).getTime()) : 0;
                    return state.sortOrder === 'asc' ? timeA - timeB : timeB - timeA;
                }
                
                if (sortBy === 'EmpMember') {
                    const numA = parseInt(valA) || 0; const numB = parseInt(valB) || 0;
                    return state.sortOrder === 'asc' ? numA - numB : numB - numA;
                }

                valA = valA.toString().toLowerCase(); valB = valB.toString().toLowerCase();
                if (valA < valB) return state.sortOrder === 'asc' ? -1 : 1;
                if (valA > valB) return state.sortOrder === 'asc' ? 1 : -1;
                return 0;
            });

            const sortFields = ['EmpMember', 'EmpName', 'CheckIN', 'reward'];
            sortFields.forEach(f => {
                const el = document.getElementById(`reg-sort-${f}`);
                if (el) {
                    if (state.sortBy === f) {
                        el.innerHTML = state.sortOrder === 'asc' ? '↑' : '↓';
                        el.className = 'inline-block ml-1 text-blue-600 font-bold';
                    } else {
                        el.innerHTML = '⇅';
                        el.className = 'inline-block ml-1 text-slate-300';
                    }
                }
            });

            const limit = state.rowsPerPage === 99999 ? sortedUsers.length : state.rowsPerPage;
            const totalPages = Math.ceil(sortedUsers.length / limit) || 1;
            if (state.currentPage > totalPages) state.currentPage = totalPages;
            const start = (state.currentPage - 1) * limit;
            const displayUsers = sortedUsers.slice(start, start + limit);

            const pageIndicator = document.getElementById('page-indicator');
            if (pageIndicator) pageIndicator.innerText = `Page ${state.currentPage} of ${totalPages}`;
            
            const btnPrev = document.getElementById('btn-prev');
            if (btnPrev) btnPrev.disabled = state.currentPage <= 1;
            
            const btnNext = document.getElementById('btn-next');
            if (btnNext) btnNext.disabled = state.currentPage >= totalPages;
            
            if (infoText) infoText.innerText = `แสดงผล ${displayUsers.length} จากทั้งหมด ${users.length} รายการ`;

            tbody.innerHTML = displayUsers.map((u, index) => {
                const checkIn = u.CheckIN ? (u.CheckIN.toDate ? u.CheckIN.toDate() : new Date(u.CheckIN)).toLocaleString('th-TH') : '-';
                const reward = u.reward || '<span class="text-slate-300">-</span>';
                
                // --- Updated Reward Status Logic ---
                let statusClaim = '-';
                if (u.ConfirmReward) {
                    // หากฟิลด์ ConfirmReward ไม่เท่ากับค่าว่าง ให้แสดง รับแล้ว (สีเขียว)
                    statusClaim = '<span class="px-2 py-1 bg-green-100 text-green-700 rounded-full text-xs">รับแล้ว</span>';
                } else if (u.reward && u.reward !== 'ไม่ได้รับรางวัล') {
                    // หากฟิลด์ reward ไม่ใช่ค่าว่าง และ ConfirmReward เป็นค่าว่าง ให้แสดง ยังไม่รับ (สีแดง)
                    statusClaim = '<span class="px-2 py-1 bg-red-100 text-red-700 rounded-full text-xs">ยังไม่รับ</span>';
                } else if (u.reward === 'ไม่ได้รับรางวัล') {
                    statusClaim = '<span class="px-2 py-1 bg-gray-100 text-gray-500 rounded-full text-xs">ไม่ได้รางวัล</span>';
                }

                const displayName = u.EmpName || `<span class="text-slate-400 text-xs">ID: ${u.citizenId ? u.citizenId.substring(0,6) : 'N/A'}...</span>`;
                
                return `<tr class="hover:bg-indigo-50">
                    <td class="px-6 text-center font-mono text-slate-500 text-sm">${u.EmpMember || '-'}</td>
                    <td class="px-6 font-medium text-slate-700 text-sm">${displayName}</td>
                    <td class="px-6 text-slate-600 text-sm">${checkIn}</td>
                    <td class="px-6 font-medium text-indigo-600 text-sm">${reward}</td>
                    <td class="px-6 text-sm">${statusClaim}</td>
                    <td class="px-6 text-right">
                        <button onclick="window.app.deleteSingleData('${u.id}')" class="text-slate-400 hover:text-red-600" title="ล้างสถานะบุคคลนี้">
                            <i data-lucide="trash-2" width="14"></i>
                        </button>
                    </td>
                </tr>`;
            }).join('');
            if(window.lucide) lucide.createIcons();
        }

        window.app.downloadRegistrationCSV = () => {
            const data = state.users;
            let filtered = [...data];
            if (state.searchTerm) {
                filtered = filtered.filter(u => (u.EmpName || '').toLowerCase().includes(state.searchTerm) || (u.EmpMember || '').toString().toLowerCase().includes(state.searchTerm));
            }
            filtered.sort((a, b) => {
                const key = state.sortBy;
                let valA = a[key]; let valB = b[key];
                if (valA === null || valA === undefined) valA = '';
                if (valB === null || valB === undefined) valB = '';
                if (key === 'CheckIN') {
                    const timeA = valA ? (valA.toDate ? valA.toDate().getTime() : new Date(valA).getTime()) : 0;
                    const timeB = valB ? (valB.toDate ? valB.toDate().getTime() : new Date(valB).getTime()) : 0;
                    return state.sortOrder === 'asc' ? timeA - timeB : timeB - timeA;
                }
                if (key === 'EmpMember') {
                    const numA = parseInt(valA) || 0; const numB = parseInt(valB) || 0;
                    return state.sortOrder === 'asc' ? numA - numB : numB - numA;
                }
                valA = valA.toString().toLowerCase(); valB = valB.toString().toLowerCase();
                if (valA < valB) return state.sortOrder === 'asc' ? -1 : 1;
                if (valA > valB) return state.sortOrder === 'asc' ? 1 : -1;
                return 0;
            });

            const headers = ["no", "ชื่อ-นามสกุล", "Check-In", "ของรางวัล", "สถานะรับรางวัล"];
            const csvRows = [headers.join(",")];
            
            filtered.forEach(u => {
                const checkInStr = u.CheckIN ? (u.CheckIN.toDate ? u.CheckIN.toDate().toLocaleString('th-TH') : u.CheckIN) : '-';
                let statusStr = '-';
                if (u.ConfirmReward) statusStr = 'รับแล้ว';
                else if (u.reward && u.reward !== 'ไม่ได้รับรางวัล') statusStr = 'ยังไม่รับ';
                else if (u.reward === 'ไม่ได้รับรางวัล') statusStr = 'ไม่ได้รางวัล';

                const row = [
                    u.EmpMember || '',
                    `"${u.EmpName || ''}"`,
                    `"${checkInStr}"`,
                    `"${u.reward || ''}"`,
                    `"${statusStr}"`
                ];
                csvRows.push(row.join(","));
            });

            const csvContent = "\uFEFF" + csvRows.join("\n");
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.setAttribute("href", url);
            link.setAttribute("download", `registration_report_${new Date().toLocaleDateString('th-TH')}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            window.app.showToast("ส่งออกไฟล์ CSV เรียบร้อยแล้ว", 'success');
        };

        // --- DIVIDEND INFO TABLE LOGIC ---
        window.app.handleDividendSearch = (val) => {
            state.divSearchTerm = val.trim().toLowerCase();
            state.divCurrentPage = 1;
            renderDividendTable(state.dividendUsers);
        };
        window.app.changeDivPage = (dir) => { state.divCurrentPage += dir; renderDividendTable(state.dividendUsers); };
        
        window.app.changeDivSort = (key) => {
            if (state.divSortBy === key) {
                state.divSortOrder = state.divSortOrder === 'asc' ? 'desc' : 'asc';
            } else {
                state.divSortBy = key;
                state.divSortOrder = 'asc';
            }
            renderDividendTable(state.dividendUsers);
        };

        function renderDividendTable(users) {
            const tbody = document.getElementById('dividend-table-body');
            if(!tbody) return;

            let filtered = [...users];
            if (state.divSearchTerm) {
                filtered = filtered.filter(u => 
                    (u.empname || '').toLowerCase().includes(state.divSearchTerm) || 
                    (u.no || '').toString().toLowerCase().includes(state.divSearchTerm)
                );
            }

            filtered.sort((a, b) => {
                const key = state.divSortBy;
                let valA = a[key]; let valB = b[key];
                if (valA === null || valA === undefined) valA = '';
                if (valB === null || valB === undefined) valB = '';

                if (key === 'dividend' || key === 'moneyback' || key === 'gratuity' || key === 'netpayment' || key === 'no') {
                    const numA = parseFloat(valA) || 0; const numB = parseFloat(valB) || 0;
                    return state.divSortOrder === 'asc' ? numA - numB : numB - numA;
                }
                if (key === 'DateLogin') {
                    const timeA = valA ? (valA.toDate ? valA.toDate().getTime() : new Date(valA).getTime()) : 0;
                    const timeB = valB ? (valB.toDate ? valB.toDate().getTime() : new Date(valB).getTime()) : 0;
                    return state.divSortOrder === 'asc' ? timeA - timeB : timeB - timeA;
                }
                valA = valA.toString().toLowerCase(); valB = valB.toString().toLowerCase();
                if (valA < valB) return state.divSortOrder === 'asc' ? -1 : 1;
                if (valA > valB) return state.sortOrder === 'asc' ? 1 : -1;
                return 0;
            });

            const total = users.length;
            const registered = users.filter(u => u.DateLogin).length;
            const meeting = users.filter(u => u.RegisMeeting).length;
            
            const totalEl = document.getElementById('div-stat-total');
            if (totalEl) totalEl.innerText = total.toLocaleString();
            
            const registeredEl = document.getElementById('div-stat-registered');
            if (registeredEl) registeredEl.innerText = registered.toLocaleString();
            
            const meetingEl = document.getElementById('div-stat-meeting');
            if (meetingEl) meetingEl.innerText = meeting.toLocaleString();

            const sortFields = ['no', 'empname', 'dividend', 'moneyback', 'gratuity', 'netpayment', 'DateLogin', 'RegisMeeting'];
            sortFields.forEach(f => {
                const el = document.getElementById(`sort-icon-${f}`);
                if (el) {
                    if (state.divSortBy === f) {
                        el.innerHTML = state.divSortOrder === 'asc' ? '↑' : '↓';
                        el.className = 'inline-block ml-1 text-blue-600 font-bold';
                    } else {
                        el.innerHTML = '⇅';
                        el.className = 'inline-block ml-1 text-slate-300';
                    }
                }
            });

            const limit = state.divRowsPerPage;
            const totalPages = Math.ceil(filtered.length / limit) || 1;
            if (state.divCurrentPage > totalPages) state.divCurrentPage = totalPages;
            const start = (state.divCurrentPage - 1) * limit;
            const display = filtered.slice(start, start + limit);

            const divPageIndicator = document.getElementById('div-page-indicator');
            if (divPageIndicator) divPageIndicator.innerText = `Page ${state.divCurrentPage} of ${totalPages}`;
            
            const btnDivPrev = document.getElementById('btn-div-prev');
            if (btnDivPrev) btnDivPrev.disabled = state.divCurrentPage <= 1;
            
            const btnDivNext = document.getElementById('btn-div-next');
            if (btnDivNext) btnDivNext.disabled = state.divCurrentPage >= totalPages;
            
            const divTableInfo = document.getElementById('div-table-info');
            if (divTableInfo) divTableInfo.innerText = `แสดงผล ${display.length} จากทั้งหมด ${filtered.length} รายการ`;

            if (display.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="text-center py-8 text-slate-400 font-medium">ไม่พบข้อมูลสมาชิก</td></tr>';
                return;
            }

            tbody.innerHTML = display.map((u) => {
                const divValue = parseFloat(u.dividend || 0).toLocaleString(undefined, {minimumFractionDigits: 2});
                const backValue = parseFloat(u.moneyback || 0).toLocaleString(undefined, {minimumFractionDigits: 2});
                const gratValue = parseFloat(u.gratuity || 0).toLocaleString(undefined, {minimumFractionDigits: 2});
                const netValue = parseFloat(u.netpayment || 0).toLocaleString(undefined, {minimumFractionDigits: 2});
                const loginDate = u.DateLogin ? (u.DateLogin.toDate ? u.DateLogin.toDate().toLocaleString('th-TH') : u.DateLogin) : '-';
                const meetingStatus = u.RegisMeeting ? `<span class="text-green-600 font-bold">${u.RegisMeeting}</span>` : '-';
                const displayNo = u.no || '-';

                return `<tr class="hover:bg-slate-50">
                    <td class="px-4 text-center font-mono text-slate-500">${displayNo}</td>
                    <td class="px-4 font-medium text-slate-800">${u.empname || '-'}</td>
                    <td class="px-4 text-right">${divValue}</td>
                    <td class="px-4 text-right">${backValue}</td>
                    <td class="px-4 text-right">${gratValue}</td>
                    <td class="px-4 text-right font-bold text-indigo-600">${netValue}</td>
                    <td class="px-4 text-slate-500">${loginDate}</td>
                    <td class="px-4">${meetingStatus}</td>
                    <td class="px-4 text-right">
                        <button onclick="window.app.resetSingleDividendData('${u.id}')" class="p-1.5 text-slate-400 hover:text-red-600 transition" title="ล้างสถานะการลงทะเบียนปันผล">
                            <i data-lucide="trash-2" width="14"></i>
                        </button>
                    </td>
                </tr>`;
            }).join('');
            if(window.lucide) lucide.createIcons();
        }

        window.app.downloadDividendCSV = () => {
            const users = state.dividendUsers;
            let filtered = [...users];
            if (state.divSearchTerm) {
                filtered = filtered.filter(u => 
                    (u.empname || '').toLowerCase().includes(state.divSearchTerm) || 
                    (u.no || '').toString().toLowerCase().includes(state.divSearchTerm)
                );
            }
            filtered.sort((a, b) => {
                const key = state.divSortBy;
                let valA = a[key]; let valB = b[key];
                if (valA === null || valA === undefined) valA = '';
                if (valB === null || valB === undefined) valB = '';
                if (key === 'dividend' || key === 'moneyback' || key === 'gratuity' || key === 'netpayment' || key === 'no') {
                    const numA = parseFloat(valA) || 0; const numB = parseFloat(valB) || 0;
                    return state.divSortOrder === 'asc' ? numA - numB : numB - numA;
                }
                valA = valA.toString().toLowerCase(); valB = valB.toString().toLowerCase();
                if (valA < valB) return state.divSortOrder === 'asc' ? -1 : 1;
                if (valA > valB) return state.sortOrder === 'asc' ? 1 : -1;
                return 0;
            });

            const headers = ["ลำดับ(no)", "ชื่อ-นามสกุล(empname)", "ปันผล", "เงินเฉลี่ยคืน", "ค่าของขวัญ", "รับสุทธิ", "ลงทะเบียน", "เข้าประชุม"];
            const csvRows = [headers.join(",")];
            
            filtered.forEach(u => {
                const login = u.DateLogin ? (u.DateLogin.toDate ? u.DateLogin.toDate().toLocaleString('th-TH') : u.DateLogin) : '-';
                const row = [
                    u.no || '',
                    `"${u.empname || ''}"`,
                    u.dividend || 0,
                    u.moneyback || 0,
                    u.gratuity || 0,
                    u.netpayment || 0,
                    `"${login}"`,
                    `"${u.RegisMeeting || ''}"`
                ];
                csvRows.push(row.join(","));
            });

            const csvContent = "\uFEFF" + csvRows.join("\n");
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.setAttribute("href", url);
            link.setAttribute("download", `dividend_report_${new Date().toLocaleDateString('th-TH')}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            window.app.showToast("ส่งออกไฟล์ CSV เรียบร้อยแล้ว", 'success');
        };

        window.app.resetSingleDividendData = async (id) => {
            if(!confirm("ต้องการล้างสถานะลงทะเบียนปันผลของสมาชิกท่านนี้?")) return;
            try {
                const ref = doc(db, dividendCollectionPath, id);
                await updateDoc(ref, {
                    DateLogin: null,
                    RegisMeeting: null,
                    DateMeeting: null
                });
                window.app.showToast("ล้างสถานะสมาชิกสำเร็จ", 'success');
            } catch(e) {
                console.error(e);
                window.app.showToast("ล้างสถานะไม่สำเร็จ", 'error');
            }
        };

        window.app.resetWinnerStatus = async (id) => {
            if(!confirm("ต้องการล้างข้อมูลรางวัลของผู้โชคดีท่านนี้?")) return;
            try {
                const ref = doc(db, finalCollectionPath, id);
                await updateDoc(ref, {
                    reward: deleteField(),
                    rewardTime: deleteField(),
                    ConfirmReward: deleteField()
                });
                window.app.showToast("ล้างข้อมูลรางวัลสำเร็จ", 'success');
            } catch(e) {
                console.error(e);
                window.app.showToast("ล้างข้อมูลไม่สำเร็จ", 'error');
            }
        };

        window.app.renderResults = () => {
            const stats = state.stats;
            const totalDb = document.getElementById('monitor-total-db');
            if (totalDb) totalDb.innerText = stats.totalDocs; 
            
            const registered = document.getElementById('monitor-registered');
            if (registered) registered.innerText = stats.registered; 
            
            const draws = document.getElementById('monitor-draws');
            if (draws) draws.innerText = stats.rewarded; 
            
            const rewarded = document.getElementById('monitor-rewarded');
            if (rewarded) rewarded.innerText = stats.rewarded; 
            
            const noreward = document.getElementById('monitor-noreward');
            if (noreward) noreward.innerText = stats.notRewarded; 
            
            const randTotal = document.getElementById('rand-stat-total');
            if (randTotal) randTotal.innerText = stats.totalDocs; 

            const randNoreward = document.getElementById('rand-stat-noreward');
            if(randNoreward) randNoreward.innerText = stats.notYetDrawn;
            
            const randRewarded = document.getElementById('rand-stat-rewarded');
            if(randRewarded) randRewarded.innerText = stats.drawnNoReward;
            
            const randClaimed = document.getElementById('rand-stat-claimed');
            if(randClaimed) randClaimed.innerText = stats.drawnWon;
            
            const randEligible = document.getElementById('rand-stat-eligible-view');
            if(randEligible) randEligible.innerText = stats.eligible;

            const filterStatusEl = document.getElementById('filter-results-status');
            const filterStatus = filterStatusEl ? filterStatusEl.value : 'all_winners';
            
            let filtered = state.users.filter(u => u.reward);
            if (filterStatus === 'no_reward') {
                filtered = state.users.filter(u => u.reward === 'ไม่ได้รับรางวัล');
            } else {
                filtered = filtered.filter(u => u.reward !== 'ไม่ได้รับรางวัล');
                if (filterStatus === 'claimed') filtered = filtered.filter(u => u.ConfirmReward);
                else if (filterStatus === 'unclaimed') filtered = filtered.filter(u => !u.ConfirmReward);
            }

            filtered.sort((a, b) => (b.rewardTime?.toDate?.() || new Date(0)) - (a.rewardTime?.toDate?.() || new Date(0)));
            const tbody = document.getElementById('results-table-body');
            if (!tbody) return;
            
            if (filtered.length === 0) { 
                tbody.innerHTML = '<tr><td colspan="6" class="px-6 py-8 text-center text-slate-400 text-sm">ไม่พบข้อมูล</td></tr>'; 
                return; 
            }
            tbody.innerHTML = filtered.map((u, index) => {
                const ts = u.rewardTime ? (u.rewardTime.toDate ? u.rewardTime.toDate() : new Date(u.rewardTime)) : new Date();
                const badge = u.ConfirmReward ? '<span class="px-2 py-1 bg-green-100 text-green-700 rounded-full text-xs">รับแล้ว</span>' : (u.reward === 'ไม่ได้รับรางวัล' ? '<span class="px-2 py-1 bg-gray-100 text-gray-500 rounded-full text-xs">ไม่ได้รางวัล</span>' : '<span class="px-2 py-1 bg-red-100 text-red-700 rounded-full text-xs">ยังไม่รับ</span>');
                const manageBtn = `<button onclick="window.app.resetWinnerStatus('${u.id}')" class="text-slate-400 hover:text-red-600 disabled:opacity-30 disabled:cursor-not-allowed transition" ${(!u.reward || u.reward === 'ไม่ได้รับรางวัล') ? 'disabled' : ''} title="ล้างรายการรางวัล"><i data-lucide="trash-2" width="14"></i></button>`;

                return `<tr>
                    <td class="px-6 text-sm">${index + 1}</td>
                    <td class="px-6 text-sm font-medium text-slate-700">${u.EmpName || '-'}</td>
                    <td class="px-6 text-indigo-600 font-bold">${u.reward || '-'}</td>
                    <td class="px-6 text-slate-500 font-mono text-xs">${ts.toLocaleTimeString('th-TH')}</td>
                    <td class="px-6">${badge}</td>
                    <td class="px-6 text-right">${manageBtn}</td>
                </tr>`;
            }).join('');
            if(window.lucide) lucide.createIcons();
        };

        function renderActivityFeed(users) {
            const list = document.getElementById('recent-activity-list');
            if (!list) return;
            
            let events = [];
            users.forEach(u => {
                const name = u.EmpName || 'Unknown';
                if (u.CheckIN) events.push({ type: 'in', date: u.CheckIN.toDate ? u.CheckIN.toDate() : new Date(u.CheckIN), name });
                if (u.CheckOUT) events.push({ type: 'out', date: u.CheckOUT.toDate ? u.CheckOUT.toDate() : new Date(u.CheckOUT), name });
            });
            events.sort((a, b) => b.date - a.date);
            const recent = events.slice(0, 50);
            if (recent.length === 0) { list.innerHTML = '<div class="text-center text-slate-400 text-sm py-8">ยังไม่มีกิจกรรม</div>'; return; }
            list.innerHTML = recent.map(evt => `<div class="flex items-start gap-3 text-sm p-2 rounded-lg bg-slate-50"><div class="${evt.type === 'in' ? 'text-blue-500' : 'text-orange-500'}"><i data-lucide="${evt.type === 'in' ? 'user-plus' : 'log-out'}" width="16"></i></div><div><p class="font-medium">${evt.name} <span class="text-slate-400 font-normal">(${evt.type === 'in' ? 'เข้า' : 'ออก'})</span></p><p class="text-[10px] text-slate-400">${evt.date.toLocaleTimeString('th-TH')}</p></div></div>`).join('');
            if(window.lucide) lucide.createIcons();
        }

        // --- CHARTS & STATS ---
        function updateCharts(inData, outData) {
            const labels = Array.from({length: 24}, (_, i) => `${i}:00`);
            const dataIn = labels.map((_, i) => inData[i] || 0);
            const dataOut = labels.map((_, i) => outData[i] || 0);

            const chartReg = document.getElementById('registrationChart');
            if (chartReg) {
                if (window.chartInInstance) {
                    window.chartInInstance.data.datasets[0].data = dataIn;
                    window.chartInInstance.update();
                } else {
                    const ctxIn = chartReg.getContext('2d');
                    window.chartInInstance = new Chart(ctxIn, {
                        type: 'line',
                        data: { labels, datasets: [{ label: 'Check-IN', data: dataIn, borderColor: '#4f46e5', backgroundColor: 'rgba(79, 70, 229, 0.1)', fill: true, tension: 0.4 }] },
                        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, ticks: { stepSize: 1, precision: 0 } } } }
                    });
                }
            }

            const chartOut = document.getElementById('checkoutChart');
            if (chartOut) {
                if (window.chartOutInstance) {
                    window.chartOutInstance.data.datasets[0].data = dataOut;
                    window.chartOutInstance.update();
                } else {
                    const ctxOut = chartOut.getContext('2d');
                    window.chartOutInstance = new Chart(ctxOut, {
                        type: 'line',
                        data: { labels, datasets: [{ label: 'Check-OUT', data: dataOut, borderColor: '#f97316', backgroundColor: 'rgba(249, 115, 22, 0.1)', fill: true, tension: 0.4 }] },
                        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, ticks: { stepSize: 1, precision: 0 } } } }
                    });
                }
            }
        }

        function processSnapshot(snapshot) {
            const users = [];
            const stats = { ...state.stats, totalDocs: snapshot.size, checkin: 0, checkout: 0, rewarded: 0, notRewarded: 0, claimed: 0, eligible: 0, registered: 0, notYetDrawn: 0, drawnNoReward: 0, drawnWon: 0 };
            const inByHour = {};
            const outByHour = {};

            snapshot.forEach(doc => {
                const d = doc.data();
                const u = { id: doc.id, ...d };
                users.push(u);

                if (d.CheckIN) {
                    stats.checkin++;
                    const h = (d.CheckIN.toDate ? d.CheckIN.toDate() : new Date(d.CheckIN)).getHours();
                    inByHour[h] = (inByHour[h] || 0) + 1;
                }
                if (d.CheckOUT) {
                    stats.checkout++;
                    const h = (d.CheckOUT.toDate ? d.CheckOUT.toDate() : new Date(d.CheckOUT)).getHours();
                    outByHour[h] = (outByHour[h] || 0) + 1;
                }
                if (d.reward) {
                    if (d.reward === 'ไม่ได้รับรางวัล') stats.notRewarded++;
                    else stats.rewarded++;
                }
                if (d.ConfirmReward) stats.claimed++;
                if (d.status && d.status.trim() !== '') {
                    stats.registered++;
                    stats.eligible++;
                    if (!d.reward) stats.notYetDrawn++;
                    else if (d.reward === 'ไม่ได้รางวัล') stats.drawnNoReward++;
                    else stats.drawnWon++;
                }
            });

            state.users = users;
            state.stats = stats;
            updateDashboardUI(stats);
            updateCharts(inByHour, outByHour);
            renderActivityFeed(users);
            renderTable(users);
            window.app.renderResults();
            if(!document.getElementById('view-randomizer').classList.contains('hidden')) window.app.onPrizeSelect();
        }

        function updateDashboardUI(stats) {
            const sCheckin = document.getElementById('stat-checkin');
            if (sCheckin) sCheckin.innerText = stats.checkin;
            
            const sCheckout = document.getElementById('stat-checkout');
            if (sCheckout) sCheckout.innerText = stats.checkout;
            
            const sRewarded = document.getElementById('stat-rewarded');
            if (sRewarded) sRewarded.innerText = stats.rewarded;
            
            const sClaimed = document.getElementById('stat-claimed');
            if (sClaimed) sClaimed.innerText = stats.claimed;
            
            const sEligible = document.getElementById('stat-eligible');
            if (sEligible) sEligible.innerText = `จากผู้มีสิทธิ์ลุ้น ${stats.eligible} คน`;
            
            const sNoReward = document.getElementById('stat-noreward');
            if(sNoReward) sNoReward.innerText = stats.notRewarded;
            
            const chartTotalIn = document.getElementById('chart-total-checkin');
            if (chartTotalIn) chartTotalIn.innerText = stats.checkin;
            
            const chartTotalOut = document.getElementById('chart-total-checkout');
            if (chartTotalOut) chartTotalOut.innerText = stats.checkout;
            
            const labelEligible = document.getElementById('label-eligible-count');
            if (labelEligible) labelEligible.innerText = stats.eligible;
            
            const manageTotal = document.getElementById('manage-total-docs');
            if (manageTotal) manageTotal.innerText = stats.totalDocs; 
            
            const manageDivTotal = document.getElementById('manage-dividend-total');
            if(manageDivTotal) manageDivTotal.innerText = stats.dividendTotal;
            
            const regSumTotal = document.getElementById('reg-summary-total');
            if(regSumTotal) regSumTotal.innerText = stats.totalDocs;
            
            const regSumReg = document.getElementById('reg-summary-registered');
            if(regSumReg) regSumReg.innerText = stats.checkin;
            
            const regSumReward = document.getElementById('reg-summary-rewarded');
            if(regSumReward) regSumReward.innerText = stats.rewarded;
            
            const barCheckout = document.getElementById('bar-checkout');
            if (barCheckout) {
                const p = stats.checkin > 0 ? (stats.checkout / stats.checkin) * 100 : 0;
                barCheckout.style.width = `${p}%`;
            }
        }

        // --- IMPORT & DIVIDEND LOGIC ---
        window.app.handleFileSelect = (e) => { const file = e.target.files[0]; if(file) { state.fileToImport = file; document.getElementById('file-name').innerText = file.name; document.getElementById('file-info').classList.remove('hidden'); document.getElementById('btn-import').disabled = false; } };
        window.app.clearFileSelection = () => { state.fileToImport = null; document.getElementById('file-upload').value = ''; document.getElementById('file-info').classList.add('hidden'); document.getElementById('btn-import').disabled = true; };
        
        window.app.handleDividendFileSelect = (e) => { const file = e.target.files[0]; if(file) { state.dividendFileToImport = file; document.getElementById('dividend-file-name').innerText = file.name; document.getElementById('dividend-file-info').classList.remove('hidden'); document.getElementById('btn-dividend-import').disabled = false; } };
        window.app.clearDividendFileSelection = () => { state.dividendFileToImport = null; document.getElementById('dividend-file-upload').value = ''; document.getElementById('dividend-file-info').classList.add('hidden'); document.getElementById('btn-dividend-import').disabled = true; };

        window.app.processImport = () => {
            if(!state.fileToImport) return;
            const file = state.fileToImport;
            const reader = new FileReader();
            document.getElementById('btn-import').disabled = true; document.getElementById('import-progress').classList.remove('hidden');
            reader.onload = async (e) => {
                try {
                    let data = [];
                    const content = e.target.result;
                    if(file.name.endsWith('.csv')) { data = csvToJson(content); } else { data = JSON.parse(content); }
                    const total = data.length; let processed = 0; const batchSize = 400;
                    for (let i = 0; i < total; i += batchSize) {
                        const chunk = data.slice(i, i + batchSize);
                        const batch = writeBatch(db);
                        for (const item of chunk) {
                            let cid = item.citizenId || item.citizenID || item.CitizenId;
                            if(cid) {
                                const hashedId = await sha256(cid.toString().replace(/-/g, '').trim());
                                const cleanItem = { ...item };
                                delete cleanItem.citizenId; delete cleanItem.citizenID; delete cleanItem.CitizenId;
                                const docRef = doc(collection(db, finalCollectionPath));
                                batch.set(docRef, { ...cleanItem, citizenId: hashedId, importedAt: serverTimestamp() });
                            }
                        }
                        await batch.commit(); processed += chunk.length;
                        document.getElementById('import-bar').style.width = `${(processed / total) * 100}%`;
                    }
                    window.app.showToast(`นำเข้าข้อมูลสำเร็จ ${total} รายการ`, 'success');
                    window.app.clearFileSelection();
                } catch(err) { console.error(err); window.app.showToast("นำเข้าล้มเหลว", 'error'); } 
                finally { document.getElementById('btn-import').disabled = false; document.getElementById('import-progress').classList.add('hidden'); }
            };
            reader.readAsText(file);
        };

        window.app.processDividendImport = () => {
            if(!state.dividendFileToImport) return;
            const file = state.dividendFileToImport;
            const reader = new FileReader();
            document.getElementById('btn-dividend-import').disabled = true; document.getElementById('dividend-import-progress').classList.remove('hidden');
            reader.onload = async (e) => {
                try {
                    let data = [];
                    const content = e.target.result;
                    if(file.name.endsWith('.csv')) { data = csvToJson(content); } else { data = JSON.parse(content); }
                    const total = data.length; let processed = 0; const batchSize = 400;
                    for (let i = 0; i < total; i += batchSize) {
                        const chunk = data.slice(i, i + batchSize);
                        const batch = writeBatch(db);
                        for (const item of chunk) {
                            let cid = item.citizenId || item.citizenID || item.CitizenId;
                            const cleanItem = { ...item };
                            delete cleanItem.citizenId; delete cleanItem.citizenID; delete cleanItem.CitizenId;
                            const hashedId = cid ? await sha256(cid.toString().replace(/-/g, '').trim()) : null;
                            const docRef = doc(collection(db, dividendCollectionPath));
                            batch.set(docRef, { 
                                ...cleanItem, 
                                citizenId: hashedId, 
                                membertype: "member",
                                DateLogin: null, 
                                RegisMeeting: null, 
                                DateMeeting: null, 
                                importedAt: serverTimestamp() 
                            });
                        }
                        await batch.commit(); processed += chunk.length;
                        document.getElementById('dividend-import-bar').style.width = `${(processed / total) * 100}%`;
                    }
                    window.app.showToast(`นำเข้าเงินปันผลสำเร็จ ${total} รายการ`, 'success');
                    window.app.clearDividendFileSelection();
                } catch(err) { console.error(err); window.app.showToast("นำเข้าปันผลล้มเหลว", 'error'); } 
                finally { document.getElementById('btn-dividend-import').disabled = false; document.getElementById('dividend-import-progress').classList.add('hidden'); }
            };
            reader.readAsText(file);
        };

        // --- RESET / DELETE ---
        window.app.confirmResetData = async () => {
            window.app.closeResetModal();
            try {
                const snap = await getDocs(query(collection(db, finalCollectionPath)));
                const chunks = []; let tmp = [];
                snap.forEach(d => { tmp.push(d); if(tmp.length >= 400) { chunks.push(tmp); tmp = []; } });
                if(tmp.length > 0) chunks.push(tmp);
                for (const c of chunks) {
                    const batch = writeBatch(db);
                    c.forEach(d => batch.update(d.ref, { 
                        CheckIN: deleteField(), 
                        CheckOUT: deleteField(), 
                        status: deleteField(), 
                        reward: deleteField(), 
                        rewardTime: deleteField(), 
                        rewardClaimTime: deleteField(),
                        ConfirmReward: deleteField()
                    }));
                    await batch.commit();
                }
                window.app.showToast("รีเซ็ตสถานะสำเร็จ", 'success');
            } catch(e) { window.app.showToast("รีเซ็ตล้มเหลว", 'error'); }
        };

        window.app.confirmResetDividendData = async () => {
            window.app.closeDividendResetModal();
            try {
                const snap = await getDocs(query(collection(db, dividendCollectionPath)));
                const chunks = []; let tmp = [];
                snap.forEach(d => { tmp.push(d); if(tmp.length >= 400) { chunks.push(tmp); tmp = []; } });
                if(tmp.length > 0) chunks.push(tmp);
                for (const c of chunks) {
                    const batch = writeBatch(db);
                    c.forEach(d => batch.update(d.ref, { DateLogin: null, RegisMeeting: null, DateMeeting: null }));
                    await batch.commit();
                }
                window.app.showToast("รีเซ็ตเงินปันผลสำเร็จ", 'success');
            } catch(e) { window.app.showToast("รีเซ็ตปันผลล้มเหลว", 'error'); }
        };

        window.app.deleteAllData = async () => {
             if(prompt("พิมพ์ 'DELETE' เพื่อลบทั้งหมด") !== 'DELETE') return;
             try {
                const snap = await getDocs(query(collection(db, finalCollectionPath)));
                const chunks = []; let tmp = [];
                snap.forEach(d => { tmp.push(d); if(tmp.length >= 400) { chunks.push(tmp); tmp = []; } });
                if(tmp.length > 0) chunks.push(tmp);
                for (const c of chunks) {
                    const b = writeBatch(db); c.forEach(d => b.delete(d.ref)); await b.commit();
                }
                window.app.showToast("ลบข้อมูลทั้งหมดแล้ว", 'success');
             } catch(e) { window.app.showToast("ลบไม่สำเร็จ", 'error'); } 
        };

        window.app.deleteAllDividendData = async () => {
             if(prompt("พิมพ์ 'CONFIRM' เพื่อลบเงินปันผล") !== 'CONFIRM') return;
             try {
                const snap = await getDocs(query(collection(db, dividendCollectionPath)));
                const chunks = []; let tmp = [];
                snap.forEach(d => { tmp.push(d); if(tmp.length >= 400) { chunks.push(tmp); tmp = []; } });
                if(tmp.length > 0) chunks.push(tmp);
                for (const c of chunks) {
                    const b = writeBatch(db); c.forEach(d => b.delete(d.ref)); await b.commit();
                }
                window.app.showToast("ลบข้อมูลปันผลทั้งหมดแล้ว", 'success');
             } catch(e) { window.app.showToast("ลบไม่สำเร็จ", 'error'); } 
        };

        // --- Updated Delete Single Data Logic ---
        window.app.deleteSingleData = async (id) => { 
            if(!confirm("ต้องการล้างสถานะท่านนี้? (Check-In, ของรางวัล, สถานะรับรางวัล)")) return; 
            try { 
                const ref = doc(db, finalCollectionPath, id);
                await updateDoc(ref, { 
                    CheckIN: deleteField(),
                    reward: deleteField(),
                    rewardTime: deleteField(),
                    status: deleteField(),
                    ConfirmReward: deleteField() // ปรับค่าให้เป็นค่าว่างตามที่ระบุ
                });
                window.app.showToast("ล้างสถานะเรียบร้อย", 'success'); 
            } catch(e) { window.app.showToast("เกิดข้อผิดพลาด", 'error'); } 
        };

        // --- PRIZES & RANDOMIZER ---
        window.app.handlePrizeSubmit = async (e) => {
             e.preventDefault(); const name = document.getElementById('prize-name').value.trim(); const qty = parseInt(document.getElementById('prize-qty').value); const total = parseInt(document.getElementById('prize-total').value);
             if(!name || qty < 1) return;
             try { await addDoc(collection(db, prizesCollectionPath), { name, qtyPerDraw: qty, totalQty: total, createdAt: serverTimestamp() }); document.getElementById('prize-form').reset(); window.app.showToast("บันทึกรางวัลแล้ว", 'success'); } catch(e) { window.app.showToast("บันทึกไม่สำเร็จ", 'error'); }
        };

        window.app.deletePrize = async (id) => { if(!confirm("ลบรางวัลนี้?")) return; await deleteDoc(doc(db, prizesCollectionPath, id)); window.app.showToast("ลบรางวัลสำเร็จ", 'success'); };
        window.app.openEditPrizeModal = (id, n, q, t) => { document.getElementById('edit-prize-id').value = id; document.getElementById('edit-prize-name').value = n; document.getElementById('edit-prize-qty').value = q; document.getElementById('edit-prize-total').value = t; document.getElementById('edit-prize-modal').classList.remove('hidden'); };
        window.app.closeEditPrizeModal = () => document.getElementById('edit-prize-modal').classList.add('hidden');
        window.app.handlePrizeUpdate = async (e) => { e.preventDefault(); const id = document.getElementById('edit-prize-id').value; const name = document.getElementById('edit-prize-name').value.trim(); const qtyPerDraw = parseInt(document.getElementById('edit-prize-qty').value); const totalQty = parseInt(document.getElementById('edit-prize-total').value); try { await updateDoc(doc(db, prizesCollectionPath, id), { name, qtyPerDraw, totalQty }); window.app.closeEditPrizeModal(); window.app.showToast("อัปเดตรางวัลแล้ว", 'success'); } catch(e) { window.app.showToast("อัปเดตไม่สำเร็จ", 'error'); } };

        window.app.onPrizeSelect = () => {
            const s = document.getElementById('select-prize'); if(!s) return;
            const o = s.options[s.selectedIndex];
            if (!s.value) { 
                const btn = document.getElementById('btn-start-random');
                if (btn) btn.disabled = true;
                return; 
            }
            const total = parseInt(o.getAttribute('data-total') || 0);
            const used = state.users.filter(u => u.reward === o.text).length;
            const rem = total - used;
            const qtyInput = document.getElementById('input-draw-qty');
            if (qtyInput) qtyInput.value = o.getAttribute('data-qty');
            const stockLabel = document.getElementById('label-stock-count');
            if (stockLabel) stockLabel.innerText = `${rem} / ${total}`;
            window.app.validateRandomizerInput();
        };

        window.app.validateRandomizerInput = () => {
            const s = document.getElementById('select-prize'); if(!s) return;
            const o = s.options[s.selectedIndex];
            const qtyInput = document.getElementById('input-draw-qty'); if(!qtyInput) return;
            const q = parseInt(qtyInput.value);
            if (!s.value) return;
            const rem = parseInt(o.getAttribute('data-total')) - state.users.filter(u => u.reward === o.text).length;
            const b = document.getElementById('btn-start-random');
            if (q > 0 && q <= rem) { 
                if (b) { b.disabled = false; b.classList.remove('opacity-50', 'cursor-not-allowed'); }
                const warn = document.getElementById('qty-warning');
                if (warn) warn.classList.add('hidden'); 
            } else { 
                if (b) { b.disabled = true; b.classList.add('opacity-50', 'cursor-not-allowed'); }
                const warn = document.getElementById('qty-warning');
                if (warn) warn.classList.remove('hidden'); 
            }
        };

        window.app.startRandomizer = async () => {
            if (state.isDrawing) return;
            const s = document.getElementById('select-prize'); if(!s) return;
            const prizeName = s.options[s.selectedIndex].text;
            const qtyInput = document.getElementById('input-draw-qty'); if(!qtyInput) return;
            const qty = parseInt(qtyInput.value);
            const eligible = state.users.filter(u => u.status && !u.reward);
            if (eligible.length === 0) return window.app.showModal("แจ้งเตือน", "ไม่มีผู้มีสิทธิ์เหลืออยู่");

            state.isDrawing = true;
            const btn = document.getElementById('btn-start-random');
            if (btn) btn.disabled = true;
            const prizeTitle = document.getElementById('screen-prize-title');
            if (prizeTitle) prizeTitle.innerText = prizeName;
            const displayArea = document.getElementById('screen-display-area');
            if (displayArea) displayArea.innerHTML = '';
            const overlay = document.getElementById('screen-overlay-controls');
            if (overlay) overlay.classList.remove('hidden');
            await new Promise(r => setTimeout(r, 1000));
            if (overlay) overlay.classList.add('hidden');

            const winners = eligible.sort(() => 0.5 - Math.random()).slice(0, qty);
            for (let i = 0; i < winners.length; i++) {
                const w = winners[i];
                const card = document.createElement('div');
                card.className = "winner-card-enter bg-white h-[65px] px-4 rounded-xl shadow-lg border-l-4 border-yellow-500 flex items-center justify-between mb-2";
                card.innerHTML = `<div class="flex items-center gap-4"><div class="w-10 h-10 bg-yellow-400 rounded-full flex items-center justify-center font-bold">${i+1}</div><h3 class="text-lg font-bold">${w.EmpName || 'Unknown'}</h3></div><span class="px-3 py-1 bg-blue-600 text-white rounded-lg text-sm">${prizeName}</span>`;
                if (displayArea) {
                    displayArea.appendChild(card);
                    displayArea.scrollTop = displayArea.scrollHeight;
                }
                confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
                await updateDoc(doc(db, finalCollectionPath, w.id), { reward: prizeName, rewardTime: serverTimestamp() });
                if(window.lucide) lucide.createIcons();
                if (i < winners.length - 1) await new Promise(r => setTimeout(r, 2000));
            }
            state.isDrawing = false;
            window.app.onPrizeSelect();
            window.app.showToast("สุ่มรางวัลสำเร็จ!", 'success');
        };

        // --- UTILS ---
        function csvToJson(csv) { const lines = csv.split('\n'); const headers = lines[0].split(',').map(h => h.trim()); return lines.slice(1).map(line => { const data = line.split(','); if (data.length < headers.length) return null; return headers.reduce((obj, nextKey, index) => { obj[nextKey] = data[index] ? data[index].trim() : ''; return obj; }, {}); }).filter(x => x); }
        setInterval(() => { const timeEl = document.getElementById('current-time'); if (timeEl) timeEl.innerText = new Date().toLocaleTimeString('th-TH'); }, 1000);

        async function init() {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) await signInWithCustomToken(auth, __initial_auth_token);
                else await signInAnonymously(auth);
                const indicator = document.getElementById('status-indicator');
                if (indicator) indicator.classList.replace('bg-red-500', 'bg-green-500');
                const statusTxt = document.getElementById('status-text');
                if (statusTxt) statusTxt.innerText = "Online";
                
                onSnapshot(query(collection(db, finalCollectionPath)), (snap) => processSnapshot(snap));
                onSnapshot(query(collection(db, prizesCollectionPath)), (snap) => {
                    const prizes = []; snap.forEach(doc => prizes.push({ id: doc.id, ...doc.data() })); 
                    state.prizes = prizes; 
                    const tbody = document.getElementById('prize-list-body');
                    if (tbody) {
                        const totalQuota = prizes.reduce((sum, p) => sum + (parseInt(p.totalQty) || 0), 0);
                        const quotaEl = document.getElementById('total-prize-quota');
                        if (quotaEl) quotaEl.innerText = totalQuota.toLocaleString();
                        tbody.innerHTML = prizes.map(p => `<tr><td class="px-4 py-3 text-sm">${p.name}</td><td class="px-4 py-3 text-center text-sm">${p.qtyPerDraw}</td><td class="px-4 py-3 text-center text-sm">${p.totalQty}</td><td class="px-4 py-3 text-right text-sm"><button onclick="window.app.openEditPrizeModal('${p.id}', '${p.name}', ${p.qtyPerDraw}, ${p.totalQty})" class="text-blue-500 mr-2"><i data-lucide="edit-3" width="16"></i></button><button onclick="window.app.deletePrize('${p.id}')" class="text-red-500"><i data-lucide="trash-2" width="16"></i></button></td></tr>`).join('');
                    }
                    const select = document.getElementById('select-prize'); 
                    if (select) {
                        const cur = select.value;
                        select.innerHTML = '<option value="">-- กรุณาเลือก --</option>' + prizes.map(p => `<option value="${p.id}" data-qty="${p.qtyPerDraw}" data-total="${p.totalQty}">${p.name}</option>`).join('');
                        select.value = cur;
                    }
                    if(!document.getElementById('view-randomizer').classList.contains('hidden')) window.app.onPrizeSelect();
                    if(window.lucide) lucide.createIcons();
                });
                onSnapshot(query(collection(db, dividendCollectionPath)), (snap) => {
                    const divUsers = [];
                    snap.forEach(doc => divUsers.push({ id: doc.id, ...doc.data() }));
                    state.dividendUsers = divUsers;
                    state.stats.dividendTotal = snap.size;
                    updateDashboardUI(state.stats);
                    if(!document.getElementById('view-dividend-info').classList.contains('hidden')) {
                        renderDividendTable(divUsers);
                    }
                });
                window.app.switchTab('dashboard');
            } catch (e) { console.error(e); }
        }

        init();
        if (window.lucide) lucide.createIcons();
    </script>
</body>
</html>