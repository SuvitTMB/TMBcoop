<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>สหกรณ์ออมทรัพย์พนักงานธนาคารทหารไทย จำกัด</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Google Font (Sarabun) -->
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Sarabun', sans-serif; }
        .hidden { display: none !important; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }
        
        /* ปุ่มนำทางหลัก ความกว้าง 50% และความสูงคงที่ 50px จัดกึ่งกลาง */
        .nav-wrapper { @apply flex justify-center w-full px-4 py-6 bg-slate-50/50; }
        .nav-container { @apply flex w-full max-w-md gap-0 overflow-hidden rounded-2xl border-2 border-blue-600 ; }
        .nav-btn { @apply w-1/2 h-[50px] text-[15px] font-bold transition-all duration-300 flex items-center justify-center gap-2 text-center border-none; }
        
        /* สีปุ่มเมื่อเลือก (สีน้ำเงิน) */
        .nav-btn-active { @apply bg-blue-600 text-white shadow-inner; }
        
        /* สีปุ่มเมื่อไม่ได้เลือก (สีเทา) */
        .nav-btn-inactive { @apply bg-gray-200 text-slate-500 hover:bg-gray-300; }
        
        .content-indent { text-indent: 3rem; }
        .shadow-lg { height: 40px;}
    </style>
</head>
<body class="bg-slate-50 min-h-screen pb-10">

    <!-- Header Section -->
    <div class="bg-gradient-to-r from-blue-700 to-indigo-800 text-white p-6 rounded-b-[2.5rem] shadow-lg mb-8 relative overflow-hidden" style="height: 167px;">
        <div class="absolute top-0 right-0 opacity-10 transform translate-x-10 -translate-y-10">
            <i data-lucide="calculator" width="150" height="150"></i>
        </div>
        
        <div class="relative z-10 flex flex-col items-center">
            <div class="bg-white/20 p-3 rounded-full mb-3 backdrop-blur-sm">
                <i data-lucide="file-text" width="32" height="32" class="text-white"></i>
            </div>
            <h1 class="text-xl font-bold text-center">รายงานเงินปันผลประจำปี 2025</h1>
            <p class="text-blue-100 text-sm mt-1">สหกรณ์ออมทรัพย์พนักงานธนาคารทหารไทย จำกัด</p>
        </div>
    </div>

    <!-- Main Content Container -->
    <main class="px-2 sm:px-4 max-w-lg mx-auto -mt-10">
        
        <!-- Search Form Screen -->
        <div id="screen-form" class="bg-white rounded-2xl shadow-xl p-6 border border-slate-100 relative z-20">
            <form id="registration-form" class="space-y-6 pt-2">
                <div class="text-center">
                    <div>
                        <label for="idCard" class="block text-sm font-semibold text-gray-700 mb-2">
                            เลขบัตรประจำตัวประชาชน
                        </label>
                        <div class="relative">
                            <input
                                type="text"
                                id="idCard"
                                placeholder="x-xxxx-xxxxx-xx-x"
                                class="w-full text-xl font-mono tracking-wide p-4 rounded-xl border-2 border-gray-200 bg-white focus:border-blue-400 focus:ring-4 focus:ring-blue-100 outline-none transition-all text-center"
                                inputmode="numeric"
                                maxlength="17"
                                autocomplete="off"
                            />
                            <i id="icon-check-valid" data-lucide="check-circle" class="hidden absolute right-4 top-1/2 transform -translate-y-1/2 text-green-500 w-6 h-6 animate-fade-in"></i>
                        </div>
                        <div class="flex justify-between items-center mt-2 px-1">
                            <p id="id-helper-text" class="text-xs text-gray-400 font-medium">กรุณากรอกตัวเลขให้ครบ 13 หลัก</p>
                            <div class="flex items-center gap-2">
                                <span class="text-[10px] text-gray-400 uppercase font-bold">จำนวน:</span>
                                <p id="id-counter" class="text-[10px] font-mono text-gray-400 bg-gray-100 px-2 py-0.5 rounded-full">0 / 13</p>
                            </div>
                        </div>
                    </div>

                    <div class="p-4 bg-blue-50 text-blue-800 rounded-xl text-xs flex gap-3 items-start mt-6 text-left border border-blue-100 leading-relaxed">
                        <i data-lucide="info" class="w-5 h-5 shrink-0 text-blue-600"></i>
                        <span>ระบบตรวจสอบรายงานเงินปันผลและการสำรวจการเข้าประชุมใหญ่ สหกรณ์ออมทรัพย์พนักงานธนาคารทหารไทย จำกัด ประจำปี 2568</span>
                    </div>
                </div>

                <button
                    type="submit"
                    id="btn-submit"
                    disabled
                    class="w-full py-4 rounded-xl font-bold text-lg shadow-lg transition-all transform active:scale-95 flex items-center justify-center gap-2 bg-gray-200 text-gray-400 cursor-not-allowed shadow-none"
                >
                    <span id="btn-text">ตรวจสอบข้อมูล</span>
                    <i id="btn-loader" data-lucide="loader-2" class="hidden animate-spin"></i>
                </button>
            </form>
        </div>

        <!-- Result Screen -->
        <div id="screen-success" class="hidden bg-white rounded-2xl shadow-xl overflow-hidden animate-fade-in relative z-20 w-full max-w-lg mx-auto border border-slate-100">
            
            <!-- Navigation Buttons Header (Height 50px) -->
            <div class="nav-wrapper border-gray-100" style="margin:0px auto 20px 5px;">
                <div class="nav-container">
                    <button onclick="window.app.switchTab('report')" id="btn-nav-report" class="nav-btn nav-btn-active transition shadow-lg" style="width:48%; margin:10px auto; color:#0056ff; background:#f1f1f1; padding: 10px auto;">
                        <span><b>รายงานปันผลปี 2025</b></span>
                    </button>
                    <button onclick="window.app.switchTab('survey')" id="btn-nav-survey" class="nav-btn nav-btn-inactive transition shadow-lg" style="width:48%; margin:10px auto; color:#f68b1f; background:#f1f1f1; padding: 10px auto;">
                        <span><b>สำรวจเข้าประชุม</b></span>
                    </button>
                </div>
            </div>

            <!-- Tab Content: Report -->
            <div id="content-report" class="p-6 pt-0 space-y-4 text-sm text-gray-800 leading-relaxed overflow-y-auto max-h-[70vh]">
                <p>เรียน คุณ <span id="res-name-report-1" class="font-bold underline text-blue-700"></span></p>
                <p class="font-bold text-gray-900 underline decoration-blue-200">เรื่อง ขอเชิญประชุมใหญ่สามัญประจำปี 2568</p>
                
                <p class="content-indent">
                    สหกรณ์ออมทรัพย์พนักงานธนาคารทหารไทย จำกัด จะประกาศจ่ายเงินปันผล ประจำปี 2568 ในอัตราร้อยละ 4.65 เงินเฉลี่ยคืนดอกเบี้ยเงินกู้อัตราร้อยละ 10.00 และเงินค่าสมนาคุณ 120 บาท ซึ่งสหกรณ์จะโอนเงินดังกล่าว หลังจากได้รับอนุมัติจากที่ประชุมใหญ่แล้ว เข้าบัญชีเงินเดือน ของสมาชิก ในวันที่ 17 กุมภาพันธ์ 2569
                </p>

                <div class="bg-blue-50 p-4 rounded-xl border border-blue-200 mt-4 shadow-sm">
                    <p class="font-bold text-blue-900 mb-2 text-center md:text-left">โดย <span id="res-name-report-2" class="underline decoration-blue-300"></span> เลขที่สมาชิก <span id="res-member-id"></span><br>จะได้รับเงิน ดังนี้</p>
                    <div class="grid grid-cols-2 gap-y-2 border-t border-blue-200 pt-3 mt-2 font-medium">
                        <span class="text-gray-600">เงินปันผล:</span>
                        <div class="text-right font-bold text-blue-700"><span id="res-dividend">0.00</span> บาท</div>
                        <span class="text-gray-600">เงินเฉลี่ยคืน:</span>
                        <div class="text-right font-bold text-blue-700"><span id="res-moneyback">0.00</span> บาท</div>
                        <span class="text-gray-600">เงินค่าสมนาคุณ:</span>
                        <div class="text-right font-bold text-blue-700"><span id="res-gratuity">0.00</span> บาท</div>
                        <span class="text-blue-900 font-bold border-t border-blue-200 pt-2 mt-1">รวมทั้งหมด:</span>
                        <div class="text-right font-bold text-blue-900 border-t border-blue-200 pt-2 mt-1"><span id="res-total">0.00</span> บาท</div>
                    </div>
                </div>
            </div>

            <!-- Tab Content: Survey -->
            <div id="content-survey" class="hidden p-6 pt-0 space-y-4 text-sm text-gray-800 leading-relaxed overflow-y-auto max-h-[70vh]">
                <div id="survey-action-box" class="pb-6 border-b border-gray-100 space-y-4">
                    <p class="font-bold text-center text-blue-900 mb-2 bg-blue-50 py-2 rounded-lg border border-blue-100">แจ้งความประสงค์การเข้าร่วมประชุม</p>
                    <div class="grid grid-cols-2 gap-4">
                        <button onclick="window.app.submitSurvey('เข้าร่วม')" class="flex flex-col items-center justify-center p-4 rounded-xl border-2 border-green-100 bg-green-50 text-green-700 hover:border-green-500 hover:bg-green-100 transition-all font-bold shadow-sm active:scale-95">
                            <i data-lucide="check-circle-2" class="mb-1 w-6 h-6"></i>
                            <span class="text-xs text-center">ต้องการเข้าร่วมประชุม</span>
                        </button>
                        <button onclick="window.app.submitSurvey('ไม่เข้าร่วม')" class="flex flex-col items-center justify-center p-4 rounded-xl border-2 border-rose-100 bg-rose-50 text-rose-700 hover:border-rose-500 hover:bg-rose-100 transition-all font-bold shadow-sm active:scale-95">
                            <i data-lucide="x-circle" class="mb-1 w-6 h-6"></i>
                            <span class="text-xs text-center">ไม่เข้าร่วมประชุม</span>
                        </button>
                    </div>
                </div>

                <div id="survey-result-box" class="hidden p-4 bg-slate-100 rounded-xl text-center border-2 border-blue-200 mb-4 animate-fade-in">
                    <p class="font-bold text-slate-800 italic text-center">ขอบคุณที่แจ้งข้อมูลให้เราทราบ</p>
                    <div class="flex items-center justify-center gap-2 mt-1">
                        <span class="text-gray-500">สถานะ:</span>
                        <p id="survey-status-text" class="text-blue-700 font-bold text-lg"></p>
                    </div>
                    <p id="survey-date-text" class="text-[10px] text-gray-400 mt-1 font-mono text-center"></p>
                </div>

                <p>เรียน คุณ <span id="res-name-survey" class="font-bold underline text-blue-700"></span></p>
                <p class="font-bold text-gray-900 underline decoration-blue-200">เรื่อง ขอเชิญประชุมใหญ่สามัญประจำปี 2568</p>
                
                <p class="content-indent">
                    ด้วยสหกรณ์ออมทรัพย์พนักงานธนาคารทหารไทย จำกัด ได้กำหนดให้มีการจัดประชุมใหญ่สามัญ ประจำปี 2568 ในวันอังคาร ที่ 17 กุมภาพันธ์ 2569 ณ ห้องประชุมออดิทอเรียม ชั้น 7 ธนาคารทหารไทยธนชาต (สำนักพหลโยธิน) เลขที่ 3000 ถนนพหลโยธิน แขวงจอมพล เขตจตุจักร กรุงเทพมหานคร โดยให้สมาชิกลงทะเบียนเข้าร่วมประชุมตั้งแต่ เวลา 11.00 น. และเริ่มการประชุมเวลา 11.30 น. เพื่อรับทราบผลการดำเนินงานของสหกรณ์และพิจารณาอนุมัติเรื่องต่าง ๆ
                </p>
                <ul class="list-disc ml-8 space-y-1 text-gray-500 italic font-medium">
                    <li>ภายในงานจะมีการจับสลากเป็นเงินสด 50 รางวัล ๆ ละ 500 บาท</li>
                    <li>ในวันดังกล่าว สหกรณ์ออมทรัพย์พนักงานธนาคารทหารไทย จำกัด จะปิดทำการและงดทำธุรกรรมทุกประเภทเพื่อจัดการประชุมใหญ่สามัญประจำปี 2568</li>
                </ul>
            </div>

            <div class="p-6 bg-gray-50 border-t border-gray-100">
                <button onclick="window.app.resetForm()" class="w-full bg-slate-800 text-white py-3 rounded-xl font-semibold hover:bg-slate-900 transition shadow-lg">
                    กลับสู่หน้าตรวจสอบ
                </button>
            </div>
        </div>

        <!-- Not Found / Error Screens -->
        <div id="screen-not-found" class="hidden bg-white rounded-2xl shadow-xl p-8 max-w-lg w-full text-center animate-fade-in relative z-20 mx-auto border border-slate-100">
            <div class="w-20 h-20 bg-amber-100 rounded-full flex items-center justify-center mx-auto mb-6">
                <i data-lucide="user-x" class="text-amber-600 w-10 h-10"></i>
            </div>
            <h2 class="text-xl font-bold text-amber-700 mb-2">ไม่พบข้อมูลสมาชิก</h2>
            <p class="text-gray-600 mb-6 text-sm leading-relaxed">
                ไม่พบเลขบัตรประชาชนนี้ในฐานข้อมูลประจำปี 2568 <br/>
                กรุณาตรวจสอบความถูกต้อง หรือติดต่อเจ้าหน้าที่สหกรณ์
            </p>
            <button onclick="window.app.resetForm()" class="w-full bg-amber-500 text-white py-3 rounded-xl font-semibold hover:bg-amber-600 transition shadow-lg shadow-amber-200">
                ตกลง
            </button>
        </div>

        <div id="screen-error" class="hidden bg-white rounded-2xl shadow-xl p-8 max-w-lg w-full text-center animate-fade-in relative z-20 mx-auto border border-slate-100">
            <div class="w-20 h-20 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-6">
                <i data-lucide="alert-triangle" class="text-red-600 w-10 h-10"></i>
            </div>
            <h2 class="text-xl font-bold text-red-700 mb-2 text-center">เกิดข้อผิดพลาด</h2>
            <p id="error-message" class="text-gray-600 mb-6 text-sm text-center font-medium">การเชื่อมต่อล้มเหลว กรุณาลองใหม่อีกครั้ง</p>
            <button onclick="window.app.resetForm()" class="w-full bg-slate-200 text-slate-700 py-3 rounded-xl font-semibold hover:bg-slate-300 transition">
                กลับไปหน้าหลัก
            </button>
        </div>

        <!-- Footer -->
        <p class="text-center text-gray-400 text-[10px] mt-8 uppercase tracking-widest leading-relaxed">
            COOP DIVIDEND SYSTEM 2568 <br/>
            © สหกรณ์ออมทรัพย์พนักงานธนาคารทหารไทย จำกัด
        </p>
    </main>

    <!-- Firebase and Application Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, updateDoc, doc, serverTimestamp, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const TARGET_COLLECTION_NAME = 'tmb_coop_dividend';
        const isSandboxEnv = typeof __firebase_config !== 'undefined';
        let firebaseConfig;
        let finalCollectionPath;

        if (isSandboxEnv) {
            firebaseConfig = JSON.parse(__firebase_config);
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            finalCollectionPath = `/artifacts/${appId}/public/data/${TARGET_COLLECTION_NAME}`; 
        } else {
            firebaseConfig = {
                apiKey: "AIzaSyAgWMzWcZPzyzoBu5eQzj2y59nKsxTWurQ",
                authDomain: "ttb-register.firebaseapp.com",
                databaseURL: "https://ttb-register-default-rtdb.asia-southeast1.firebasedate.app",
                projectId: "ttb-register",
                storageBucket: "ttb-register.firebasestorage.app",
                messagingSenderId: "1070273157855",
                appId: "1:1070273157855:web:5c8120e1df27e233d8676a"
            };
            finalCollectionPath = TARGET_COLLECTION_NAME;
        }

        const state = { user: null, idCard: '', currentMember: null, activeTab: 'report' };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        async function sha256(message) {
            try {
                const msgBuffer = new TextEncoder().encode(message);
                const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
                return Array.from(new Uint8Array(hashBuffer)).map(b => b.toString(16).padStart(2, '0')).join('');
            } catch (e) {
                console.error("Hash error:", e);
                return null;
            }
        }

        const formatMoney = (val) => {
            const num = Number(val || 0);
            return num.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        };

        window.app = {
            switchTab: (tab) => {
                state.activeTab = tab;
                const rBtn = document.getElementById('btn-nav-report');
                const sBtn = document.getElementById('btn-nav-survey');
                const rContent = document.getElementById('content-report');
                const sContent = document.getElementById('content-survey');

                if (tab === 'report') {
                    rBtn.className = "nav-btn nav-btn-active transition shadow-lg";
                    sBtn.className = "nav-btn nav-btn-inactive transition shadow-lg";
                    rContent.classList.remove('hidden');
                    sContent.classList.add('hidden');
                } else {
                    rBtn.className = "nav-btn nav-btn-inactive transition shadow-lg";
                    sBtn.className = "nav-btn nav-btn-active transition shadow-lg";
                    rContent.classList.add('hidden');
                    sContent.classList.remove('hidden');
                }
                if (window.lucide) lucide.createIcons();
            },
            submitSurvey: async (status) => {
                if (!state.currentMember || !state.user) return;
                try {
                    const memberDocId = state.currentMember.id;
                    const docRef = doc(db, finalCollectionPath, memberDocId);
                    
                    // ปรับค่าบันทึกตามสั่ง: RegisMeeting = "แจ้งเข้าร่วม" หรือ "ไม่เข้าร่วม"
                    const regisMeetingValue = (status === 'เข้าร่วม') ? 'แจ้งเข้าร่วม' : 'ไม่เข้าร่วม';
                    
                    // บันทึกลง RegisMeeting และ DateMeeting
                    await updateDoc(docRef, { 
                        "RegisMeeting": regisMeetingValue, 
                        "DateMeeting": serverTimestamp() 
                    });
                    
                    document.getElementById('survey-action-box').classList.add('hidden');
                    const resBox = document.getElementById('survey-result-box');
                    resBox.classList.remove('hidden');
                    document.getElementById('survey-status-text').innerText = regisMeetingValue;
                    document.getElementById('survey-date-text').innerText = `บันทึกสำเร็จเมื่อ: ${new Date().toLocaleString('th-TH')}`;
                } catch (err) {
                    console.error("Survey Error:", err);
                    document.getElementById('error-message').innerText = "ไม่สามารถบันทึกข้อมูลได้ กรุณาติดต่อเจ้าหน้าที่";
                    document.getElementById('screen-success').classList.add('hidden');
                    document.getElementById('screen-error').classList.remove('hidden');
                }
            },
            resetForm: () => {
                const screens = ['screen-success', 'screen-not-found', 'screen-error', 'screen-form'];
                screens.forEach(id => document.getElementById(id).classList.add('hidden'));
                document.getElementById('screen-form').classList.remove('hidden');
                
                document.getElementById('idCard').value = '';
                state.idCard = '';
                state.currentMember = null;
                window.app.switchTab('report');
                
                document.getElementById('survey-action-box').classList.remove('hidden');
                document.getElementById('survey-result-box').classList.add('hidden');

                const btn = document.getElementById('btn-submit');
                btn.disabled = true;
                btn.className = "w-full py-4 rounded-xl font-bold text-lg transition-all flex items-center justify-center gap-2 bg-gray-200 text-gray-400 cursor-not-allowed shadow-none";
                document.getElementById('icon-check-valid').classList.add('hidden');
                document.getElementById('idCard').classList.remove('border-blue-500', 'bg-blue-50/30');
                document.getElementById('id-counter').innerText = '0 / 13';
                document.getElementById('id-counter').className = 'text-[10px] font-mono text-gray-400 bg-gray-100 px-2 py-0.5 rounded-full';
                document.getElementById('idCard').focus();
            }
        };

        function populateMemberData(data) {
            const empname = data.empname || data.EmpName || "สมาชิก";
            
            // อัปเดตชื่อในทุกจุด รวมถึง Tab ที่ 2 (res-name-survey)
            if(document.getElementById('res-name-report-1')) document.getElementById('res-name-report-1').innerText = empname;
            if(document.getElementById('res-name-report-2')) document.getElementById('res-name-report-2').innerText = empname;
            if(document.getElementById('res-name-survey')) document.getElementById('res-name-survey').innerText = empname;
            
            document.getElementById('res-member-id').innerText = data.memberId || "-";
            document.getElementById('res-dividend').innerText = formatMoney(data.dividend);
            document.getElementById('res-moneyback').innerText = formatMoney(data.moneyback);
            document.getElementById('res-gratuity').innerText = formatMoney(data.gratuity);
            document.getElementById('res-total').innerText = formatMoney(data.netpayment);

            // เช็คสถานะ RegisMeeting
            if (data["RegisMeeting"]) {
                document.getElementById('survey-action-box').classList.add('hidden');
                const resBox = document.getElementById('survey-result-box');
                resBox.classList.remove('hidden');
                document.getElementById('survey-status-text').innerText = data["RegisMeeting"];
                const dt = data.DateMeeting?.toDate ? data.DateMeeting.toDate() : (data.DateMeeting ? new Date(data.DateMeeting) : null);
                document.getElementById('survey-date-text').innerText = dt ? `บันทึกเมื่อ: ${dt.toLocaleString('th-TH')}` : "";
            }
        }

        async function initAuth() {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (e) { console.error("Auth initialization failed", e); }
        }

        onAuthStateChanged(auth, (u) => { state.user = u; });

        function handleIdInput(e) {
            let raw = e.target.value.replace(/[^0-9]/g, '');
            if (raw.length > 13) raw = raw.slice(0, 13);
            
            let formatted = '';
            if (raw.length > 0) {
                formatted += raw.substring(0, 1);
                if (raw.length > 1) {
                    formatted += '-' + raw.substring(1, 5);
                    if (raw.length > 5) {
                        formatted += '-' + raw.substring(5, 10);
                        if (raw.length > 10) {
                            formatted += '-' + raw.substring(10, 12);
                            if (raw.length > 12) {
                                formatted += '-' + raw.substring(12, 13);
                            }
                        }
                    }
                }
            }
            
            state.idCard = formatted;
            e.target.value = formatted;
            
            const btn = document.getElementById('btn-submit');
            const icon = document.getElementById('icon-check-valid');
            const counter = document.getElementById('id-counter');
            counter.innerText = `${raw.length} / 13`;
            
            if (raw.length === 13) {
                 e.target.classList.add('border-blue-500', 'bg-blue-50/30');
                 icon.classList.remove('hidden');
                 btn.disabled = false;
                 btn.className = "w-full py-4 rounded-xl font-bold text-lg shadow-lg transition-all transform active:scale-95 flex items-center justify-center gap-2 bg-blue-600 text-white shadow-blue-200 hover:bg-blue-700";
                 counter.className = 'text-[10px] font-mono text-white bg-green-500 px-2 py-0.5 rounded-full';
            } else {
                 e.target.classList.remove('border-blue-500', 'bg-blue-50/30');
                 icon.classList.add('hidden');
                 btn.disabled = true;
                 btn.className = "w-full py-4 rounded-xl font-bold text-lg transition-all flex items-center justify-center gap-2 bg-gray-200 text-gray-400 cursor-not-allowed shadow-none";
                 counter.className = 'text-[10px] font-mono text-gray-400 bg-gray-100 px-2 py-0.5 rounded-full';
            }
        }

        async function submitForm(e) {
            e.preventDefault();
            if (!state.user) {
                await initAuth();
                if (!state.user) return;
            }

            const btn = document.getElementById('btn-submit');
            const btnText = document.getElementById('btn-text');
            const btnLoader = document.getElementById('btn-loader');
            
            btn.disabled = true;
            btnText.innerText = "กำลังตรวจสอบ...";
            btnLoader.classList.remove('hidden');

            try {
                const rawIdText = String(state.idCard.replace(/-/g, ''));
                const hashId = await sha256(rawIdText);
                
                if (!hashId) throw new Error("Encryption failed");

                const q = query(collection(db, finalCollectionPath), where("citizenId", "==", hashId));
                const snap = await getDocs(q);

                if (!snap.empty) {
                    const memberDoc = snap.docs[0];
                    const docRef = doc(db, finalCollectionPath, memberDoc.id);
                    
                    // บันทึกวันที่และเวลาลงในฟิลด์ DateLogin เมื่อตรวจสอบสำเร็จ
                    await updateDoc(docRef, { "DateLogin": serverTimestamp() });
                    
                    state.currentMember = { id: memberDoc.id, ...memberDoc.data() };
                    populateMemberData(state.currentMember);
                    document.getElementById('screen-form').classList.add('hidden');
                    document.getElementById('screen-success').classList.remove('hidden');
                } else {
                    document.getElementById('screen-form').classList.add('hidden');
                    document.getElementById('screen-not-found').classList.remove('hidden');
                }
            } catch (err) {
                console.error("Submission error:", err);
                document.getElementById('error-message').innerText = "เกิดข้อผิดพลาด: " + err.message;
                document.getElementById('screen-form').classList.add('hidden');
                document.getElementById('screen-error').classList.remove('hidden');
            } finally {
                btn.disabled = false;
                btnText.innerText = "ตรวจสอบข้อมูล";
                btnLoader.classList.add('hidden');
                if (window.lucide) lucide.createIcons();
            }
        }

        document.getElementById('registration-form').addEventListener('submit', submitForm);
        document.getElementById('idCard').addEventListener('input', handleIdInput);
        window.addEventListener('load', () => {
            document.getElementById('idCard').focus();
            initAuth();
            if (window.lucide) lucide.createIcons();
        });

    </script>
</body>
</html>