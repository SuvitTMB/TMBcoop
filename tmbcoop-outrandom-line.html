<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ลงทะเบียนออกและลุ้นรางวัล - สหกรณ์ออมทรัพย์ฯ</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Google Font (Sarabun) -->
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;700&display=swap" rel="stylesheet">

    <!-- Confetti for Lucky Draw -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <style>
        body { font-family: 'Sarabun', sans-serif; }
        .hidden { display: none !important; }
        /* Custom Animations */
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
        
        @keyframes bounce-slow {
            0%, 100% { transform: translateY(-5%); }
            50% { transform: translateY(5%); }
        }
        .animate-bounce-slow { animation: bounce-slow 2s infinite; }

        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen pb-10">

    <!-- Header Section -->
    <div class="bg-gradient-to-r from-purple-600 to-indigo-700 text-white p-6 rounded-b-[2.5rem] shadow-lg mb-8 relative overflow-hidden">
        <div class="absolute top-0 right-0 opacity-10 transform translate-x-10 -translate-y-10">
            <i data-lucide="gift" width="150" height="150"></i>
        </div>
        
        <div class="relative z-10 flex flex-col items-center">
            <div class="bg-white/20 p-3 rounded-full mb-3 backdrop-blur-sm">
                <i data-lucide="party-popper" width="32" height="32" class="text-white"></i>
            </div>
            <h1 class="text-xl font-bold text-center">กิจกรรมลุ้นรางวัล</h1>
            <p class="text-purple-100 text-sm mt-1">สหกรณ์ออมทรัพย์พนักงานธนาคารทหารไทย จำกัด</p>
        </div>
    </div>

    <!-- Main Content Container -->
    <main class="px-2 sm:px-4 max-w-lg mx-auto -mt-10">
        
        <!-- Form Screen (Check-out first) -->
        <div id="screen-form" class="bg-white rounded-2xl shadow-xl p-6 border border-slate-100 relative z-20">
            <form id="registration-form" class="space-y-6 pt-2">
                <center>
                    <h2 class="text-lg font-bold text-gray-700 mb-4">ลงทะเบียนออกเพื่อลุ้นรางวัล</h2>
                    <div>
                        <label for="idCard" class="block text-sm font-semibold text-gray-700 mb-2">
                            เลขบัตรประจำตัวประชาชน
                        </label>
                        <div class="relative">
                            <input
                                type="text"
                                id="idCard"
                                placeholder="x-xxxx-xxxxx-xx-x"
                                class="w-full text-xl font-mono tracking-wide p-4 rounded-xl border-2 border-gray-200 bg-white focus:border-purple-400 focus:ring-4 focus:ring-purple-100 outline-none transition-all text-center"
                                inputmode="numeric"
                                maxlength="17"
                            />
                            <i id="icon-check-valid" data-lucide="check-circle" class="hidden absolute right-4 top-1/2 transform -translate-y-1/2 text-green-500 w-6 h-6 animate-fade-in"></i>
                        </div>
                        <p class="text-xs text-gray-400 mt-2 ml-1">กรุณากรอกตัวเลข 13 หลักให้ครบถ้วน</p>
                    </div>

                    <div class="p-3 bg-purple-50 text-purple-800 rounded-lg text-xs flex gap-2 items-start" style="margin-top:25px;">
                        <i data-lucide="shield-alert" class="w-4 h-4 shrink-0 mt-0.5"></i>
                        <span>ระบบจำกัดสิทธิ์ 1 เครื่อง / 1 ท่าน หากลงทะเบียนแล้วจะไม่สามารถเปลี่ยนเครื่องได้</span>
                    </div>
                </center>

                <button
                    type="submit"
                    id="btn-submit"
                    disabled
                    class="w-full py-3 rounded-lg font-semibold text-base shadow-lg transition-all transform active:scale-95 flex items-center justify-center gap-2 bg-gray-200 text-gray-400 cursor-not-allowed shadow-none"
                >
                    <span id="btn-text">ลงทะเบียนออก</span>
                    <i id="btn-loader" data-lucide="loader-2" class="hidden animate-spin"></i>
                </button>
            </form>
        </div>

        <!-- Success Screen (Check-out Done & Reward Summary) -->
        <div id="screen-success" class="hidden bg-white rounded-2xl shadow-xl p-8 w-full text-center animate-fade-in relative z-20">
            <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <i data-lucide="check-circle" class="text-green-600 w-10 h-10"></i>
            </div>
            
            <h2 id="success-title" class="text-xl font-bold text-gray-800 mb-4">ลงทะเบียนออกสำเร็จ</h2>
            
            <!-- Time Grid -->
            <div class="grid grid-cols-2 gap-3 mb-6">
                <div class="bg-blue-50 p-3 rounded-xl border border-blue-100 flex flex-col items-center justify-center">
                    <p class="text-xs font-bold text-blue-800 uppercase mb-1">ลงทะเบียนเข้า</p>
                    <p id="success-checkin-time" class="text-blue-600 font-mono text-sm font-semibold">--:--</p>
                </div>
                <div class="bg-orange-50 p-3 rounded-xl border border-orange-100 flex flex-col items-center justify-center">
                    <p class="text-xs font-bold text-orange-800 uppercase mb-1">ลงทะเบียนออก</p>
                    <p id="success-checkout-time" class="text-orange-600 font-mono text-sm font-semibold">--:--</p>
                </div>
            </div>
            
            <!-- Message Box (Will be hidden when reward exists) -->
            <div id="msg-box-recorded" class="bg-green-50 border border-green-100 rounded-xl p-5 mb-6 text-left shadow-sm">
                <h3 id="success-msg-header" class="font-bold text-green-900 mb-2 text-lg flex items-center gap-2">
                    <i data-lucide="calendar-check" width="20"></i> บันทึกเวลาเรียบร้อย
                </h3>
                <p id="success-msg-body" class="text-sm text-gray-700">
                    ท่านได้ลงทะเบียนออกและมีสิทธิ์ลุ้นรับรางวัลพิเศษ และขอให้ท่านเดินทางกลับโดยสวัสดิภาพ
                </p>
            </div>
            
            <!-- Lucky Draw Action Area -->
            <div id="lucky-draw-action-container">
                <!-- Case 1: Button for new draw -->
                <button id="btn-start-draw" onclick="window.app.goToLuckyDraw()" class="w-full bg-gradient-to-r from-yellow-400 to-orange-500 text-white py-4 rounded-xl font-bold shadow-lg shadow-orange-200 hover:shadow-orange-300 transform hover:-translate-y-1 transition-all flex items-center justify-center gap-2 text-lg animate-bounce-slow">
                    <i data-lucide="gift" width="24"></i> กดเพื่อสุ่มของรางวัล
                </button>

                <!-- Case 2: Display Reward (Already drawn) -->
                <div id="reward-display-badge" class="hidden w-full bg-gradient-to-r from-purple-100 to-pink-100 border-2 border-purple-300 rounded-xl p-4 text-center shadow-inner mb-4">
                    <p class="text-sm text-purple-600 font-semibold mb-1">ของรางวัลของคุณคือ</p>
                    <p id="reward-name-text" class="text-xl font-bold text-purple-800">...</p>
                </div>

                <!-- Case 3: Claim Button (Added for Summary Page) -->
                <div id="claim-section-summary" class="hidden">
                    <button id="btn-claim-reward-summary" onclick="window.app.claimReward('summary')" class="w-full bg-green-600 text-white px-8 py-3 rounded-xl font-bold shadow-lg hover:bg-green-700 transition transform hover:scale-105 mb-2">
                        <i data-lucide="check-square" class="inline-block w-5 h-5 mr-1 mb-1"></i> ยืนยันการรับรางวัลแล้ว
                    </button>
                    <p id="text-claim-time-summary" class="text-xs text-gray-600 font-sm bg-green-50 p-3 rounded-lg border border-green-200 hidden">
                        <i data-lucide="clock" class="inline-block w-4 h-4 mr-1"></i> รับรางวัลเมื่อ: <span id="claim-time-val-summary"></span>
                    </p>
                </div>
            </div>

            <!-- Back to Registration Button -->
            <button onclick="window.app.resetForm()" class="mt-6 w-full bg-gray-200 text-gray-700 py-3 rounded-xl font-semibold hover:bg-gray-300 transition flex items-center justify-center gap-2">
                <i data-lucide="log-out" width="18"></i> กลับสู่หน้าลงทะเบียน
            </button>
        </div>

        <!-- Lucky Draw Screen (Spinning & Result) -->
        <div id="screen-luckydraw" class="hidden bg-white rounded-2xl shadow-xl p-6 w-full text-center animate-fade-in relative z-20 min-h-[400px] flex flex-col items-center justify-center">
            
            <!-- State 1: Validating -->
            <div id="draw-state-validating" class="w-full">
                <div class="w-24 h-24 bg-blue-50 rounded-full flex items-center justify-center mx-auto mb-6 animate-pulse">
                    <i data-lucide="scan-face" class="text-blue-500 w-12 h-12"></i>
                </div>
                <h2 class="text-xl font-bold text-gray-800 mb-2">กำลังตรวจสอบข้อมูลพนักงาน...</h2>
                <p class="text-gray-500 text-sm">กรุณารอสักครู่ ระบบกำลังยืนยันสิทธิ์ของท่าน</p>
                <div class="mt-6 w-full bg-gray-200 rounded-full h-2.5 dark:bg-gray-200 overflow-hidden">
                    <div class="bg-blue-600 h-2.5 rounded-full" style="width: 0%; transition: width 2s ease-in-out;" id="validate-progress"></div>
                </div>
            </div>

            <!-- State 2: Spinning -->
            <div id="draw-state-spinning" class="hidden w-full">
                <div class="relative w-32 h-32 mx-auto mb-6">
                    <div class="absolute inset-0 border-4 border-t-purple-500 border-gray-200 rounded-full animate-spin"></div>
                    <div class="absolute inset-0 flex items-center justify-center">
                        <i data-lucide="gift" class="text-purple-500 w-12 h-12"></i>
                    </div>
                </div>
                <h2 class="text-2xl font-bold text-purple-700 mb-2" id="spin-text">กำลังสุ่มรางวัล...</h2>
                <div class="h-8 overflow-hidden relative mt-2">
                    <div id="prize-ticker" class="text-gray-400 text-lg transition-all duration-100">...</div>
                </div>
            </div>

            <!-- State 3: Result -->
            <div id="draw-state-result" class="hidden w-full">
                <div class="mb-2 text-yellow-500">
                    <i data-lucide="crown" width="60" height="60" class="mx-auto"></i>
                </div>
                <h2 class="text-lg font-bold text-gray-500 mb-1">ยินดีด้วย! ท่านได้รับ</h2>
                <div class="bg-gradient-to-r from-yellow-100 to-orange-100 border-2 border-yellow-300 p-6 rounded-2xl mb-6 shadow-inner relative overflow-hidden">
                    <div class="absolute top-0 right-0 p-2 opacity-20"><i data-lucide="sparkles" width="40"></i></div>
                    <h1 id="prize-result-name" class="text-2xl font-black text-transparent bg-clip-text bg-gradient-to-r from-yellow-600 to-red-600 drop-shadow-sm mb-4">
                        รอสักครู่...
                    </h1>
                </div>
                
                <!-- Claim Reward Section -->
                <div id="claim-section" class="mb-6">
                    <button id="btn-claim-reward" onclick="window.app.claimReward('result')" class="bg-green-600 text-white px-8 py-3 rounded-xl font-bold shadow-lg hover:bg-green-700 transition transform hover:scale-105 hidden">
                        <i data-lucide="check-square" class="inline-block w-5 h-5 mr-1 mb-1"></i> ยืนยันการรับรางวัลแล้ว
                    </button>
                    <p id="text-claim-time" class="text-green-700 font-medium bg-green-50 p-3 rounded-lg border border-green-200 hidden">
                        <i data-lucide="clock" class="inline-block w-4 h-4 mr-1"></i> รับรางวัลเมื่อ: <span id="claim-time-val" class="font-bold"></span>
                    </p>
                </div>

                <p class="text-xs text-gray-400 mb-6">กรุณาให้เจ้าน้าที่ทำการกดปุ่มยืนยันการรับรางวัล</p>

                <button onclick="window.app.backToSummary()" class="w-full bg-gray-800 text-white py-3 rounded-xl font-semibold hover:bg-gray-900 transition">
                    กลับสู่หน้าหลัก (Check-out)
                </button>
            </div>

        </div>

        <!-- Error Screen -->
        <div id="screen-error-device" class="hidden bg-white rounded-2xl shadow-xl p-8 w-full text-center animate-fade-in relative z-20">
            <div class="w-20 h-20 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-6">
                <i data-lucide="alert-triangle" class="text-red-600 w-10 h-10"></i>
            </div>
            <h2 class="text-xl font-bold text-red-700 mb-2">เกิดข้อผิดพลาด</h2>
            <p id="error-msg-text" class="text-gray-600 mb-6 text-sm">ไม่สามารถดำเนินการได้</p>
            <button onclick="window.location.reload()" class="w-full bg-gray-200 text-gray-700 py-3 rounded-xl font-semibold hover:bg-gray-300 transition">ปิด</button>
        </div>

        <!-- Not Found Screen -->
        <div id="screen-not-found" class="hidden bg-white rounded-2xl shadow-xl p-8 w-full text-center animate-fade-in relative z-20">
            <div class="w-20 h-20 bg-amber-100 rounded-full flex items-center justify-center mx-auto mb-6">
                <i data-lucide="user-x" class="text-amber-600 w-10 h-10"></i>
            </div>
            <h2 class="text-xl font-bold text-amber-700 mb-2">ไม่พบข้อมูล</h2>
            <p class="text-gray-600 mb-6 text-sm">กรุณาลงทะเบียนเข้าก่อนทำการลงทะเบียนออก</p>
            <button onclick="window.app.resetForm()" class="w-full bg-amber-500 text-white py-3 rounded-xl font-semibold hover:bg-amber-600 transition">ปิด</button>
        </div>

        <p class="text-center text-gray-400 text-xs mt-8">
            ระบบสุ่มรางวัลสมาชิกสหกรณ์ <br/>
            © 2024 สหกรณ์ออมทรัพย์พนักงานธนาคารทหารไทย จำกัด
        </p>
    </main>

    <script type="module">
const _0x85a3a4=_0x47f1;(function(_0x4dd6e8,_0xcdc80d){const _0x279bf0=_0x47f1,_0x1a1364=_0x4dd6e8();while(!![]){try{const _0x424d9c=parseInt(_0x279bf0(0xf9))/0x1*(parseInt(_0x279bf0(0x112))/0x2)+parseInt(_0x279bf0(0x10f))/0x3+parseInt(_0x279bf0(0xea))/0x4+-parseInt(_0x279bf0(0xee))/0x5+-parseInt(_0x279bf0(0x162))/0x6*(-parseInt(_0x279bf0(0x156))/0x7)+-parseInt(_0x279bf0(0x16d))/0x8*(parseInt(_0x279bf0(0xef))/0x9)+-parseInt(_0x279bf0(0x139))/0xa*(parseInt(_0x279bf0(0x157))/0xb);if(_0x424d9c===_0xcdc80d)break;else _0x1a1364['push'](_0x1a1364['shift']());}catch(_0x4db9a5){_0x1a1364['push'](_0x1a1364['shift']());}}}(_0xddf4,0x982ef));import{initializeApp}from'https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js';import{getAuth,signInAnonymously,onAuthStateChanged,signInWithCustomToken}from'https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js';import{getFirestore,collection,updateDoc,doc,serverTimestamp,query,where,getDocs,getDoc,addDoc,onSnapshot}from'https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js';const TARGET_COLLECTION_NAME=_0x85a3a4(0x144),PRIZES_COLLECTION_NAME=_0x85a3a4(0x171),isSandboxEnv=typeof __firebase_config!==_0x85a3a4(0x107);let firebaseConfig,finalCollectionPath,prizesCollectionPath;if(isSandboxEnv){firebaseConfig=JSON['parse'](__firebase_config);const appId=typeof __app_id!==_0x85a3a4(0x107)?__app_id:'default-app-id';finalCollectionPath=_0x85a3a4(0x13d)+appId+'/public/data/coop_registrations',prizesCollectionPath=_0x85a3a4(0x13d)+appId+_0x85a3a4(0x102)+PRIZES_COLLECTION_NAME;}else firebaseConfig={'apiKey':_0x85a3a4(0x11a),'authDomain':'ttb-register.firebaseapp.com','databaseURL':'https://ttb-register-default-rtdb.asia-southeast1.firebasedate.app','projectId':_0x85a3a4(0x136),'storageBucket':_0x85a3a4(0x12a),'messagingSenderId':'1070273157855','appId':_0x85a3a4(0x173),'measurementId':_0x85a3a4(0x15e)},finalCollectionPath=TARGET_COLLECTION_NAME,prizesCollectionPath=PRIZES_COLLECTION_NAME;const app=initializeApp(firebaseConfig),auth=getAuth(app),db=getFirestore(app),state={'user':null,'idCard':'','currentDocId':null,'userHash':null,'currentReward':null,'prizesList':[],'winnersCount':{}};async function sha256(_0x486435){const _0x1c9e53=_0x85a3a4,_0x199deb=new TextEncoder()['encode'](_0x486435),_0xe6ea41=await crypto[_0x1c9e53(0x164)][_0x1c9e53(0x127)]('SHA-256',_0x199deb),_0x3e5fc0=Array[_0x1c9e53(0xf2)](new Uint8Array(_0xe6ea41));return _0x3e5fc0[_0x1c9e53(0x14d)](_0x516fbb=>_0x516fbb[_0x1c9e53(0x103)](0x10)['padStart'](0x2,'0'))['join']('');}function getDeviceId(){const _0x30cebb=_0x85a3a4,_0x288f37=_0x30cebb(0xed);let _0x5ed9d9=localStorage[_0x30cebb(0x154)](_0x288f37);if(!_0x5ed9d9){const _0x444fef=document[_0x30cebb(0x153)][_0x30cebb(0xfe)](new RegExp(_0x30cebb(0x12f)+_0x288f37+_0x30cebb(0x14b)));_0x444fef&&(_0x5ed9d9=_0x444fef[0x2],localStorage[_0x30cebb(0xf3)](_0x288f37,_0x5ed9d9));}return!_0x5ed9d9?(_0x5ed9d9=_0x30cebb(0x134)+Date['now']()[_0x30cebb(0x103)](0x24)+Math[_0x30cebb(0x125)]()[_0x30cebb(0x103)](0x24)[_0x30cebb(0x147)](0x2,0x9),localStorage[_0x30cebb(0xf3)](_0x288f37,_0x5ed9d9),document[_0x30cebb(0x153)]=_0x288f37+'='+_0x5ed9d9+_0x30cebb(0x105)):document[_0x30cebb(0x153)]=_0x288f37+'='+_0x5ed9d9+_0x30cebb(0x105),_0x5ed9d9;}function setLocalRegistration(_0x38a83d){const _0x39ea64=_0x85a3a4;localStorage[_0x39ea64(0xf3)](_0x39ea64(0x16c),_0x38a83d);}function getLocalRegistration(){const _0x20ede3=_0x85a3a4;return localStorage['getItem'](_0x20ede3(0x16c));}function _0xddf4(){const _0x582ba6=['ไม่สามารถบันทึกของรางวัลได้','status','ลงทะเบียนสำเร็จ','เกิดข้อผิดพลาด:\x20','screen-form','bg-gray-200','165465UTFIZf','name','CheckOUT','773586mSbZWs','btn-text','app','success-checkout-time','submit','getElementById','error-msg-text','border-gray-200','AIzaSyAgWMzWcZPzyzoBu5eQzj2y59nKsxTWurQ','กำลังบันทึก...','เครื่องนี้ถูกผูกบัญชีอื่นแล้ว\x20(ไม่สามารถลงทะเบียนใหม่ได้)','width','length','claim-section-summary','btn-claim-reward','empty','userHash','validate-progress','btn-claim-reward-summary','random','innerHTML','digest','ลงทะเบียนออก','remove','ttb-register.firebasestorage.app','text-claim-time-summary','load','claim-time-val','checked-out','(^|\x20)','hover:bg-purple-700','focus','classList','เกิดข้อผิดพลาดในการตรวจสอบข้อมูล','DEV-','error','ttb-register','text-claim-time','forEach','60hiVzYs','slice','resetForm','100%','artifacts/','draw-state-result','text-white','totalQty','querySelector','screen-error-device','style','tmb_coop','reward','border-purple-500','substr','icon-check-valid','cursor-not-allowed','btn-start-draw','=([^;]+)','lucide','map','btn-submit','currentReward','disabled','replace','prize-result-name','cookie','getItem','กำลังตรวจสอบ...','13958ohdERK','2094466CSYUmE','rewardClaimTime','ท่านเคยได้รับรางวัลแล้ว','data','บันทึกการรับรางวัลไม่สำเร็จ\x20กรุณาลองใหม่','deviceId','then','G-9DJLWJ5LQ1','toLocaleString','push','#draw-state-result\x20h2','2508tDWHAJ','bg-purple-50/30','subtle','toDate','add','th-TH','addEventListener','กำลังค้นหา...','screen-success','btn-loader','coop_registered_citizen_id','365864jbJjMP','shadow-purple-200','innerText','hidden','coop_gift','draw-state-validating','1:1070273157855:web:5c8120e1df27e233d8676a','508592RCOirk','idCard','prizesList','coop_device_identifier','679985UBnVbB','54xcsboW','ไม่พบข้อมูลผู้ใช้\x20กรุณาลงทะเบียนใหม่','user','from','setItem','draw-state-spinning','summary','CheckIN','value','Save\x20Prize\x20Error:','3ZigAEh','exists','bg-purple-600','ยินดีด้วย!\x20ท่านได้รับ','shadow-none','match','claim-time-val-summary','success-checkin-time','text-gray-400','/public/data/','toString','msg-box-recorded',';\x20path=/;\x20max-age=31536000','currentDocId','undefined','citizenId'];_0xddf4=function(){return _0x582ba6;};return _0xddf4();}window['app']={'resetForm':()=>{const _0x3641c5=_0x85a3a4;['screen-success',_0x3641c5(0x142),'screen-not-found','screen-luckydraw'][_0x3641c5(0x138)](_0x3cfe9c=>document[_0x3641c5(0x117)](_0x3cfe9c)['classList']['add'](_0x3641c5(0x170))),document[_0x3641c5(0x117)](_0x3641c5(0x10d))[_0x3641c5(0x132)][_0x3641c5(0x129)](_0x3641c5(0x170)),document['getElementById']('idCard')[_0x3641c5(0xf7)]='',document[_0x3641c5(0x117)](_0x3641c5(0x148))['classList'][_0x3641c5(0x166)](_0x3641c5(0x170)),document[_0x3641c5(0x117)](_0x3641c5(0x11f))[_0x3641c5(0x132)][_0x3641c5(0x166)]('hidden'),document[_0x3641c5(0x117)](_0x3641c5(0x104))[_0x3641c5(0x132)][_0x3641c5(0x129)]('hidden');const _0x25c269=document[_0x3641c5(0x117)]('btn-submit');_0x25c269[_0x3641c5(0x150)]=!![],_0x25c269[_0x3641c5(0x132)][_0x3641c5(0x166)]('bg-gray-200','text-gray-400'),_0x25c269[_0x3641c5(0x132)][_0x3641c5(0x129)](_0x3641c5(0xfb),_0x3641c5(0x13f)),document[_0x3641c5(0x117)](_0x3641c5(0x113))[_0x3641c5(0x16f)]=_0x3641c5(0x128),document[_0x3641c5(0x117)](_0x3641c5(0x16b))[_0x3641c5(0x132)]['add']('hidden'),state[_0x3641c5(0xeb)]='',state[_0x3641c5(0x106)]=null,state[_0x3641c5(0x14f)]=null,document[_0x3641c5(0x117)](_0x3641c5(0xeb))[_0x3641c5(0x131)]();},'goToLuckyDraw':async()=>{const _0x4a2147=_0x85a3a4;document['getElementById'](_0x4a2147(0x16a))[_0x4a2147(0x132)][_0x4a2147(0x166)](_0x4a2147(0x170)),document['getElementById']('screen-luckydraw')[_0x4a2147(0x132)]['remove'](_0x4a2147(0x170)),document['getElementById'](_0x4a2147(0x172))[_0x4a2147(0x132)][_0x4a2147(0x129)](_0x4a2147(0x170)),document[_0x4a2147(0x117)](_0x4a2147(0xf4))[_0x4a2147(0x132)][_0x4a2147(0x166)](_0x4a2147(0x170)),document[_0x4a2147(0x117)](_0x4a2147(0x13e))[_0x4a2147(0x132)][_0x4a2147(0x166)](_0x4a2147(0x170)),setTimeout(()=>{const _0x2b122c=_0x4a2147;document[_0x2b122c(0x117)](_0x2b122c(0x123))[_0x2b122c(0x143)]['width']='50%';},0x64),setTimeout(()=>{const _0x1079e1=_0x4a2147;document[_0x1079e1(0x117)](_0x1079e1(0x123))['style'][_0x1079e1(0x11d)]=_0x1079e1(0x13c);},0x5dc),setTimeout(async()=>{const _0x2c61f8=_0x4a2147;if(state[_0x2c61f8(0x106)])try{const _0x32a626=doc(db,finalCollectionPath,state[_0x2c61f8(0x106)]),_0x9a2cd2=await getDoc(_0x32a626),_0x11c156=_0x9a2cd2[_0x2c61f8(0x15a)]();_0x9a2cd2[_0x2c61f8(0xfa)]()&&_0x11c156[_0x2c61f8(0x145)]?showResult(_0x11c156['reward'],!![],_0x11c156[_0x2c61f8(0x158)]):startSpinning();}catch(_0x15d84e){console['error'](_0x15d84e),alert(_0x2c61f8(0x133)),window['app'][_0x2c61f8(0x13b)]();}else alert(_0x2c61f8(0xf0)),window[_0x2c61f8(0x114)]['resetForm']();},0x7d0);},'backToSummary':()=>{const _0x3d1c8b=_0x85a3a4;document[_0x3d1c8b(0x117)]('screen-luckydraw')[_0x3d1c8b(0x132)]['add'](_0x3d1c8b(0x170)),document[_0x3d1c8b(0x117)]('screen-success')['classList']['remove'](_0x3d1c8b(0x170)),state[_0x3d1c8b(0x14f)]&&(state[_0x3d1c8b(0x106)]&&getDoc(doc(db,finalCollectionPath,state[_0x3d1c8b(0x106)]))[_0x3d1c8b(0x15d)](_0x30b081=>{const _0x4be4f1=_0x3d1c8b;_0x30b081[_0x4be4f1(0xfa)]()&&updateSuccessScreen(_0x30b081['data']()[_0x4be4f1(0x145)],_0x30b081[_0x4be4f1(0x15a)]()[_0x4be4f1(0x158)]);}));},'claimReward':async _0x4a2a9d=>{const _0xe4a859=_0x85a3a4;if(!state['currentDocId'])return;const _0x370f8e=_0x4a2a9d===_0xe4a859(0xf5),_0xd43ddb=_0x370f8e?_0xe4a859(0x124):_0xe4a859(0x120),_0x475c9e=_0x370f8e?'text-claim-time-summary':_0xe4a859(0x137),_0x482745=_0x370f8e?_0xe4a859(0xff):_0xe4a859(0x12d),_0x1402ff=document[_0xe4a859(0x117)](_0xd43ddb),_0x44cdc9=_0x1402ff[_0xe4a859(0x126)];_0x1402ff[_0xe4a859(0x150)]=!![],_0x1402ff[_0xe4a859(0x16f)]=_0xe4a859(0x11b);try{await updateDoc(doc(db,finalCollectionPath,state[_0xe4a859(0x106)]),{'rewardClaimTime':serverTimestamp()});const _0x4e19f1=new Date(),_0x493b67=_0x4e19f1[_0xe4a859(0x15f)]('th-TH');_0x1402ff[_0xe4a859(0x132)][_0xe4a859(0x166)](_0xe4a859(0x170)),document[_0xe4a859(0x117)](_0x475c9e)['classList']['remove'](_0xe4a859(0x170)),document[_0xe4a859(0x117)](_0x482745)[_0xe4a859(0x16f)]=_0x493b67,confetti({'particleCount':0x64,'spread':0x3c,'origin':{'y':0.7}});}catch(_0x170e5d){console[_0xe4a859(0x135)](_0x170e5d),alert(_0xe4a859(0x15b)),_0x1402ff['disabled']=![],_0x1402ff[_0xe4a859(0x126)]=_0x44cdc9;}}};function setupListeners(){const _0x2bf3fb=_0x85a3a4,_0x5f4e1d=query(collection(db,prizesCollectionPath));onSnapshot(_0x5f4e1d,_0x69a462=>{const _0x33b141=_0x47f1,_0x5e0008=[];_0x69a462['forEach'](_0xeef10d=>_0x5e0008[_0x33b141(0x160)](_0xeef10d[_0x33b141(0x15a)]())),state[_0x33b141(0xec)]=_0x5e0008;});const _0x2a714e=query(collection(db,finalCollectionPath),where(_0x2bf3fb(0x145),'>',''));onSnapshot(_0x2a714e,_0x17a44c=>{const _0x330dd7=_0x2bf3fb,_0x56e3b2={};_0x17a44c[_0x330dd7(0x138)](_0x35b616=>{const _0x1a081c=_0x330dd7,_0x5643=_0x35b616['data']()[_0x1a081c(0x145)];if(_0x5643)_0x56e3b2[_0x5643]=(_0x56e3b2[_0x5643]||0x0)+0x1;}),state['winnersCount']=_0x56e3b2;});}function updateSuccessScreen(_0x2a85cc,_0x2f52b2){const _0x4d77c3=_0x85a3a4;document[_0x4d77c3(0x117)](_0x4d77c3(0x14a))[_0x4d77c3(0x132)][_0x4d77c3(0x166)](_0x4d77c3(0x170));const _0x357f4f=document[_0x4d77c3(0x117)]('reward-display-badge');_0x357f4f['classList'][_0x4d77c3(0x129)](_0x4d77c3(0x170)),document[_0x4d77c3(0x117)]('reward-name-text')['innerText']=_0x2a85cc,document[_0x4d77c3(0x117)](_0x4d77c3(0x104))[_0x4d77c3(0x132)][_0x4d77c3(0x166)](_0x4d77c3(0x170));const _0x19551d=document[_0x4d77c3(0x117)](_0x4d77c3(0x11f)),_0x531468=document[_0x4d77c3(0x117)](_0x4d77c3(0x124)),_0x3e334f=document['getElementById'](_0x4d77c3(0x12b)),_0x533bee=document[_0x4d77c3(0x117)](_0x4d77c3(0xff));_0x19551d['classList'][_0x4d77c3(0x129)](_0x4d77c3(0x170));if(_0x2f52b2){_0x531468[_0x4d77c3(0x132)][_0x4d77c3(0x166)](_0x4d77c3(0x170)),_0x3e334f[_0x4d77c3(0x132)]['remove']('hidden');const _0x2d16b7=_0x2f52b2[_0x4d77c3(0x165)]?_0x2f52b2[_0x4d77c3(0x165)]():new Date(_0x2f52b2);_0x533bee[_0x4d77c3(0x16f)]=_0x2d16b7[_0x4d77c3(0x15f)](_0x4d77c3(0x167));}else _0x531468[_0x4d77c3(0x132)][_0x4d77c3(0x129)]('hidden'),_0x3e334f[_0x4d77c3(0x132)][_0x4d77c3(0x166)]('hidden');}function startSpinning(){const _0x3b347f=_0x85a3a4;document['getElementById'](_0x3b347f(0x172))['classList'][_0x3b347f(0x166)](_0x3b347f(0x170)),document[_0x3b347f(0x117)](_0x3b347f(0xf4))[_0x3b347f(0x132)][_0x3b347f(0x129)](_0x3b347f(0x170));const _0x3033b9=[];state[_0x3b347f(0xec)][_0x3b347f(0x138)](_0x204917=>{const _0x2952cc=_0x3b347f,_0x54999e=parseInt(_0x204917[_0x2952cc(0x140)])||0x0,_0x3649a2=state['winnersCount'][_0x204917[_0x2952cc(0x110)]]||0x0;_0x54999e>_0x3649a2&&_0x3033b9['push'](_0x204917[_0x2952cc(0x110)]);});const _0x273ad5=_0x3033b9[_0x3b347f(0x11e)]>0x0?_0x3033b9:[_0x3b347f(0x169)],_0xbecd42=document[_0x3b347f(0x117)]('prize-ticker');let _0x3d856a=0x0;const _0xf2b4e7=setInterval(()=>{const _0x625d84=_0x3b347f;_0xbecd42[_0x625d84(0x16f)]=_0x273ad5[Math['floor'](Math[_0x625d84(0x125)]()*_0x273ad5[_0x625d84(0x11e)])],_0x3d856a++,_0x3d856a>0x14&&(clearInterval(_0xf2b4e7),finalizePrize());},0x64);}async function finalizePrize(){const _0x4579d6=_0x85a3a4,_0x3f9e69=[];state[_0x4579d6(0xec)]['forEach'](_0x1e7bc0=>{const _0x72bee=_0x4579d6,_0x1edbe1=parseInt(_0x1e7bc0[_0x72bee(0x140)])||0x0,_0x1c27e1=state['winnersCount'][_0x1e7bc0['name']]||0x0;_0x1edbe1>_0x1c27e1&&_0x3f9e69[_0x72bee(0x160)](_0x1e7bc0[_0x72bee(0x110)]);});if(_0x3f9e69[_0x4579d6(0x11e)]===0x0){alert('ขออภัย\x20ของรางวัลหมดแล้ว'),window[_0x4579d6(0x114)][_0x4579d6(0x13b)]();return;}const _0x17a876=_0x3f9e69[Math['floor'](Math['random']()*_0x3f9e69[_0x4579d6(0x11e)])];try{state[_0x4579d6(0x106)]&&(await updateDoc(doc(db,finalCollectionPath,state[_0x4579d6(0x106)]),{'reward':_0x17a876,'rewardTime':serverTimestamp()}),showResult(_0x17a876,![],null));}catch(_0x454f3e){console['error'](_0x4579d6(0xf8),_0x454f3e),alert(_0x4579d6(0x109));}}function showResult(_0xd792c1,_0x444feb,_0x4862d0){const _0x3705b5=_0x85a3a4;state[_0x3705b5(0x14f)]=_0xd792c1,document[_0x3705b5(0x117)](_0x3705b5(0xf4))[_0x3705b5(0x132)]['add'](_0x3705b5(0x170)),document[_0x3705b5(0x117)](_0x3705b5(0x172))['classList'][_0x3705b5(0x166)](_0x3705b5(0x170)),document['getElementById']('draw-state-result')[_0x3705b5(0x132)][_0x3705b5(0x129)](_0x3705b5(0x170));const _0x5db1e9=_0x444feb?_0x3705b5(0x159):_0x3705b5(0xfc);document[_0x3705b5(0x141)](_0x3705b5(0x161))['innerText']=_0x5db1e9,document[_0x3705b5(0x117)](_0x3705b5(0x152))['innerText']=_0xd792c1;const _0x2700fd=document[_0x3705b5(0x117)]('btn-claim-reward'),_0x20271c=document[_0x3705b5(0x117)](_0x3705b5(0x137)),_0x17a501=document['getElementById'](_0x3705b5(0x12d));if(_0x4862d0){_0x2700fd[_0x3705b5(0x132)][_0x3705b5(0x166)](_0x3705b5(0x170)),_0x20271c['classList'][_0x3705b5(0x129)](_0x3705b5(0x170));const _0x393be5=_0x4862d0[_0x3705b5(0x165)]?_0x4862d0[_0x3705b5(0x165)]():new Date(_0x4862d0);_0x17a501[_0x3705b5(0x16f)]=_0x393be5[_0x3705b5(0x15f)]('th-TH');}else _0x2700fd[_0x3705b5(0x132)][_0x3705b5(0x129)]('hidden'),_0x2700fd[_0x3705b5(0x150)]=![],_0x20271c[_0x3705b5(0x132)]['add'](_0x3705b5(0x170));!_0x444feb&&confetti({'particleCount':0x96,'spread':0x46,'origin':{'y':0.6}});}async function submitForm(_0x48fa21){const _0x3de7b4=_0x85a3a4;_0x48fa21['preventDefault']();if(!state['user'])return;const _0x307646=document[_0x3de7b4(0x117)](_0x3de7b4(0x14e)),_0x487f14=document[_0x3de7b4(0x117)](_0x3de7b4(0x113)),_0x2dcc3f=document[_0x3de7b4(0x117)]('btn-loader');_0x307646['disabled']=!![],_0x487f14[_0x3de7b4(0x16f)]=_0x3de7b4(0x155),_0x2dcc3f[_0x3de7b4(0x132)][_0x3de7b4(0x129)](_0x3de7b4(0x170));try{const _0xf3964e=getDeviceId(),_0x4b66c4=state[_0x3de7b4(0xeb)][_0x3de7b4(0x151)](/-/g,''),_0x2e6c1b=await sha256(_0x4b66c4);state[_0x3de7b4(0x122)]=_0x2e6c1b;const _0x233d4c=getLocalRegistration();if(_0x233d4c&&_0x233d4c!==_0x2e6c1b){document[_0x3de7b4(0x117)](_0x3de7b4(0x118))[_0x3de7b4(0x16f)]='อุปกรณ์นี้ได้ทำการลงทะเบียนให้กับหมายเลขบัตรประชาชนอื่นไปแล้ว\x20ไม่สามารถลงทะเบียนซ้ำได้',document[_0x3de7b4(0x117)](_0x3de7b4(0x10d))['classList']['add'](_0x3de7b4(0x170)),document[_0x3de7b4(0x117)]('screen-error-device')[_0x3de7b4(0x132)][_0x3de7b4(0x129)]('hidden');return;}const _0xc8a22=query(collection(db,finalCollectionPath),where(_0x3de7b4(0x108),'==',_0x2e6c1b)),_0x13b1c7=await getDocs(_0xc8a22);if(!_0x13b1c7['empty']){const _0x403a44=_0x13b1c7['docs'][0x0],_0x109a2f=_0x403a44[_0x3de7b4(0x15a)]();if(_0x109a2f[_0x3de7b4(0x15c)]&&_0x109a2f['deviceId']!==_0xf3964e){document[_0x3de7b4(0x117)]('error-msg-text')['innerHTML']='รหัสบัตรประชาชนนี้\x20ผูกกับโทรศัพท์เครื่องอื่นแล้ว<br>(ไม่สามารถเปลี่ยนเครื่องได้)',document[_0x3de7b4(0x117)](_0x3de7b4(0x10d))[_0x3de7b4(0x132)]['add']('hidden'),document[_0x3de7b4(0x117)](_0x3de7b4(0x142))[_0x3de7b4(0x132)][_0x3de7b4(0x129)](_0x3de7b4(0x170));return;}state[_0x3de7b4(0x106)]=_0x403a44['id'];let _0x271922='-';if(_0x109a2f[_0x3de7b4(0xf6)]){const _0x4126c9=_0x109a2f['CheckIN']['toDate']?_0x109a2f[_0x3de7b4(0xf6)][_0x3de7b4(0x165)]():new Date(_0x109a2f[_0x3de7b4(0xf6)]);_0x271922=_0x4126c9[_0x3de7b4(0x15f)](_0x3de7b4(0x167));}let _0x24e427='';const _0x397b2d=new Date();_0x24e427=_0x397b2d['toLocaleString'](_0x3de7b4(0x167));const _0x12dc5a={};let _0x54f78c=![];!_0x109a2f['deviceId']&&(_0x12dc5a[_0x3de7b4(0x15c)]=_0xf3964e,_0x54f78c=!![]);if(!_0x109a2f['CheckOUT'])_0x12dc5a[_0x3de7b4(0x111)]=serverTimestamp(),_0x109a2f[_0x3de7b4(0xf6)]?_0x12dc5a[_0x3de7b4(0x10a)]=_0x3de7b4(0x10b):_0x12dc5a[_0x3de7b4(0x10a)]=_0x3de7b4(0x12e),_0x54f78c=!![];else{const _0x3b759d=_0x109a2f[_0x3de7b4(0x111)][_0x3de7b4(0x165)]?_0x109a2f['CheckOUT'][_0x3de7b4(0x165)]():new Date(_0x109a2f[_0x3de7b4(0x111)]);_0x24e427=_0x3b759d[_0x3de7b4(0x15f)](_0x3de7b4(0x167));}_0x54f78c&&await updateDoc(doc(db,finalCollectionPath,_0x403a44['id']),_0x12dc5a),setLocalRegistration(_0x2e6c1b),document[_0x3de7b4(0x117)](_0x3de7b4(0x100))[_0x3de7b4(0x16f)]=_0x271922,document[_0x3de7b4(0x117)](_0x3de7b4(0x115))['innerText']=_0x24e427,document[_0x3de7b4(0x117)](_0x3de7b4(0x10d))[_0x3de7b4(0x132)][_0x3de7b4(0x166)](_0x3de7b4(0x170)),document[_0x3de7b4(0x117)](_0x3de7b4(0x16a))[_0x3de7b4(0x132)]['remove']('hidden'),_0x109a2f[_0x3de7b4(0x145)]?(state[_0x3de7b4(0x14f)]=_0x109a2f[_0x3de7b4(0x145)],updateSuccessScreen(_0x109a2f[_0x3de7b4(0x145)],_0x109a2f[_0x3de7b4(0x158)])):(state[_0x3de7b4(0x14f)]=null,document[_0x3de7b4(0x117)](_0x3de7b4(0x14a))[_0x3de7b4(0x132)]['remove'](_0x3de7b4(0x170)),document[_0x3de7b4(0x117)]('reward-display-badge')[_0x3de7b4(0x132)]['add'](_0x3de7b4(0x170)),document['getElementById'](_0x3de7b4(0x11f))['classList'][_0x3de7b4(0x166)]('hidden'));}else{const _0x505c1e=query(collection(db,finalCollectionPath),where(_0x3de7b4(0x15c),'==',_0xf3964e)),_0x2eef99=await getDocs(_0x505c1e);if(!_0x2eef99[_0x3de7b4(0x121)])document['getElementById'](_0x3de7b4(0x118))[_0x3de7b4(0x16f)]=_0x3de7b4(0x11c),document[_0x3de7b4(0x117)](_0x3de7b4(0x10d))[_0x3de7b4(0x132)][_0x3de7b4(0x166)](_0x3de7b4(0x170)),document['getElementById'](_0x3de7b4(0x142))[_0x3de7b4(0x132)][_0x3de7b4(0x129)](_0x3de7b4(0x170));else{const _0xa0f0de=await addDoc(collection(db,finalCollectionPath),{'citizenId':_0x2e6c1b,'deviceId':_0xf3964e,'CheckIN':serverTimestamp(),'CheckOUT':serverTimestamp(),'status':_0x3de7b4(0x10b)});state[_0x3de7b4(0x106)]=_0xa0f0de['id'],setLocalRegistration(_0x2e6c1b);const _0x4a56ab=new Date(),_0x111e8e=_0x4a56ab[_0x3de7b4(0x15f)]('th-TH');updateSuccessUI(_0x111e8e,_0x111e8e,null,null,!![]);}}}catch(_0x1515a4){console['error'](_0x1515a4),alert(_0x3de7b4(0x10c)+_0x1515a4['message']);}finally{_0x307646[_0x3de7b4(0x150)]=![],_0x487f14[_0x3de7b4(0x16f)]=_0x3de7b4(0x128),_0x2dcc3f[_0x3de7b4(0x132)]['add'](_0x3de7b4(0x170)),validateForm();}}function _0x47f1(_0x59999f,_0x512275){_0x59999f=_0x59999f-0xea;const _0xddf4f0=_0xddf4();let _0x47f138=_0xddf4f0[_0x59999f];return _0x47f138;}function handleIdInput(_0x424b6f){const _0x35c785=_0x85a3a4;let _0xd75253=_0x424b6f['target'][_0x35c785(0xf7)][_0x35c785(0x151)](/[^0-9]/g,'');if(_0xd75253[_0x35c785(0x11e)]>0xd)_0xd75253=_0xd75253[_0x35c785(0x13a)](0x0,0xd);let _0x2010cb=_0xd75253;if(_0xd75253[_0x35c785(0x11e)]>0x1)_0x2010cb=_0xd75253[_0x35c785(0x13a)](0x0,0x1)+'-'+_0xd75253[_0x35c785(0x13a)](0x1);if(_0xd75253[_0x35c785(0x11e)]>0x5)_0x2010cb=_0x2010cb[_0x35c785(0x13a)](0x0,0x6)+'-'+_0x2010cb[_0x35c785(0x13a)](0x6);if(_0xd75253['length']>0xa)_0x2010cb=_0x2010cb[_0x35c785(0x13a)](0x0,0xc)+'-'+_0x2010cb[_0x35c785(0x13a)](0xc);if(_0xd75253[_0x35c785(0x11e)]>0xc)_0x2010cb=_0x2010cb[_0x35c785(0x13a)](0x0,0xf)+'-'+_0x2010cb[_0x35c785(0x13a)](0xf);document[_0x35c785(0x117)](_0x35c785(0xeb))[_0x35c785(0xf7)]=_0x2010cb,state[_0x35c785(0xeb)]=_0x2010cb;const _0x4befbf=document[_0x35c785(0x117)](_0x35c785(0x148)),_0x426921=document[_0x35c785(0x117)]('idCard');_0xd75253[_0x35c785(0x11e)]===0xd?(_0x426921[_0x35c785(0x132)][_0x35c785(0x166)](_0x35c785(0x146),_0x35c785(0x163)),_0x426921[_0x35c785(0x132)][_0x35c785(0x129)](_0x35c785(0x119)),_0x4befbf[_0x35c785(0x132)][_0x35c785(0x129)]('hidden')):(_0x426921['classList'][_0x35c785(0x129)]('border-purple-500',_0x35c785(0x163)),_0x426921[_0x35c785(0x132)][_0x35c785(0x166)](_0x35c785(0x119)),_0x4befbf[_0x35c785(0x132)][_0x35c785(0x166)]('hidden')),validateForm();}function validateForm(){const _0x19ccb1=_0x85a3a4,_0x167741=state[_0x19ccb1(0xeb)][_0x19ccb1(0x151)](/[^0-9]/g,'')[_0x19ccb1(0x11e)]===0xd,_0xea0958=document[_0x19ccb1(0x117)]('btn-submit');_0x167741?(_0xea0958[_0x19ccb1(0x150)]=![],_0xea0958[_0x19ccb1(0x132)][_0x19ccb1(0x166)](_0x19ccb1(0xfb),_0x19ccb1(0x13f),_0x19ccb1(0x130),_0x19ccb1(0x16e)),_0xea0958[_0x19ccb1(0x132)]['remove'](_0x19ccb1(0x10e),_0x19ccb1(0x101),'cursor-not-allowed',_0x19ccb1(0xfd))):(_0xea0958['disabled']=!![],_0xea0958['classList'][_0x19ccb1(0x129)](_0x19ccb1(0xfb),_0x19ccb1(0x13f),_0x19ccb1(0x130),_0x19ccb1(0x16e)),_0xea0958['classList']['add'](_0x19ccb1(0x10e),_0x19ccb1(0x101),_0x19ccb1(0x149),_0x19ccb1(0xfd)));}document[_0x85a3a4(0x117)]('registration-form')[_0x85a3a4(0x168)](_0x85a3a4(0x116),submitForm),document[_0x85a3a4(0x117)]('idCard')[_0x85a3a4(0x168)]('input',handleIdInput),window['addEventListener'](_0x85a3a4(0x12c),()=>document['getElementById'](_0x85a3a4(0xeb))[_0x85a3a4(0x131)]());async function initAuth(){const _0x3b335c=_0x85a3a4;typeof __initial_auth_token!==_0x3b335c(0x107)&&__initial_auth_token?await signInWithCustomToken(auth,__initial_auth_token):await signInAnonymously(auth),setupListeners();}onAuthStateChanged(auth,_0x5f42fb=>state[_0x85a3a4(0xf1)]=_0x5f42fb),initAuth();if(window[_0x85a3a4(0x14c)])lucide['createIcons']();

    </script>
</body>
</html>