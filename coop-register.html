<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>สหกรณ์ออมทรัพย์พนักงานธนาคารทหารไทย จำกัด</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Canvas Confetti for Fireworks -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <!-- Google Font (Sarabun) -->
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Sarabun', sans-serif; }
        .hidden { display: none !important; }
        /* Custom Animations */
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
        @keyframes bounce-slow { 0%, 100% { transform: translateY(-5%); } 50% { transform: translateY(0); } }
        .animate-bounce-slow { animation: bounce-slow 2s infinite; }
        
        /* Remove number arrows */
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen pb-10">

    <!-- Header Section -->
    <div class="bg-gradient-to-r from-blue-700 to-indigo-800 text-white p-6 rounded-b-[2.5rem] shadow-lg mb-8 relative overflow-hidden">
        <div class="absolute top-0 right-0 opacity-10 transform translate-x-10 -translate-y-10">
            <i data-lucide="shield-check" width="150" height="150"></i>
        </div>
        
        <div class="relative z-10 flex flex-col items-center">
            <div class="bg-white/20 p-3 rounded-full mb-3 backdrop-blur-sm">
                <i data-lucide="calendar" width="32" height="32" class="text-white"></i>
            </div>
            <h1 class="text-xl font-bold text-center">ประชุมใหญ่สามัญประจำปี 2568</h1>
            <p class="text-blue-100 text-sm mt-1">สหกรณ์ออมทรัพย์พนักงานธนาคารทหารไทย จำกัด</p>
        </div>
    </div>

    <!-- Main Content Container -->
    <main class="px-2 sm:px-4 max-w-lg mx-auto -mt-10">
        
        <!-- Registration Form Screen -->
        <div id="screen-form" class="bg-white rounded-2xl shadow-xl p-6 border border-slate-100 relative z-20">
            
            <form id="registration-form" class="space-y-6 pt-2">
                <center>
                <!-- Single Input ID Card -->
                <div>
                    <label for="idCard" class="block text-sm font-semibold text-gray-700 mb-2">
                        เลขบัตรประจำตัวประชาชน
                    </label>
                    <div class="relative">
                        <input
                            type="text"
                            id="idCard"
                            placeholder="x-xxxx-xxxxx-xx-x"
                            class="w-full text-xl font-mono tracking-wide p-4 rounded-xl border-2 border-gray-200 bg-white focus:border-blue-400 focus:ring-4 focus:ring-blue-100 outline-none transition-all text-center"
                            inputmode="numeric"
                            maxlength="17"
                        />
                        <i id="icon-check-valid" data-lucide="check-circle" class="hidden absolute right-4 top-1/2 transform -translate-y-1/2 text-green-500 w-6 h-6 animate-fade-in"></i>
                    </div>
                    <p class="text-xs text-gray-400 mt-2 ml-1">กรุณากรอกตัวเลข 13 หลักให้ครบถ้วน</p>
                </div>

                <!-- Info Box -->
                <div class="p-3 bg-blue-50 text-blue-800 rounded-lg text-xs flex gap-2 items-start" style="margin-top:25px; text-align: left;">
                    <i data-lucide="info" class="w-4 h-4 shrink-0 mt-0.5"></i>
                    <span>ผู้ที่จะได้รับรางวัลค่าตอบแทนการประชุม 200 บาท<br>จะต้องลงทะเบียนเข้า และลงทะเบียนออก เท่านั้น</span>
                </div>
                </center>

                <!-- Submit Button -->
                <button
                    type="submit"
                    id="btn-submit"
                    disabled
                    class="w-full py-3 rounded-lg font-semibold text-base shadow-lg transition-all transform active:scale-95 flex items-center justify-center gap-2 bg-gray-200 text-gray-400 cursor-not-allowed shadow-none"
                >
                    <span id="btn-text">ตรวจสอบ / ลงทะเบียน</span>
                    <i id="btn-loader" data-lucide="loader-2" class="hidden animate-spin"></i>
                </button>
            </form>
        </div>

        <!-- Success Screen -->
        <div id="screen-success" class="hidden bg-white rounded-2xl shadow-xl p-8 w-full text-center animate-fade-in relative z-20">
            <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <i data-lucide="check-circle" class="text-green-600 w-10 h-10"></i>
            </div>
            
            <!-- EmpName above Success Title -->
            <h3 id="success-user-name" class="text-lg font-bold text-blue-600 mb-1 hidden"></h3>
            <h2 id="success-title" class="text-xl font-bold text-gray-800 mb-1">ลงทะเบียนสำเร็จ</h2>
            <p id="success-checkin-datetime" class="text-blue-600 font-medium mb-6 text-xs">--/--/---- --:--</p>
            
            <!-- Reward Box -->
            <div class="bg-blue-50 border border-blue-100 rounded-xl p-5 mb-6 text-left shadow-sm">
                <!-- Reward Content Area (Dynamic) -->
                <div id="reward-area" class="py-2 text-center">
                    <!-- Default state: Gift Icon and waiting message -->
                    <div id="reward-waiting" class="space-y-3">
                        <div class="flex justify-center">
                            <i data-lucide="package" class="w-16 h-16 text-blue-400 animate-bounce-slow"></i>
                        </div>
                        <p class="text-blue-800 font-bold">ลุ้นรางวัลพิเศษ 50 รางวัล</p>
                        <p class="text-xs text-gray-500 italic">ระบบจะแสดงผลที่นี่หากท่านได้รับรางวัล</p>
                    </div>

                    <!-- Winner state: Congratulations message (Updated: Removed yellow styling) -->
                    <div id="reward-winner" class="hidden space-y-4 p-4 rounded-xl animate-fade-in">
                        <div class="flex justify-center">
                            <i data-lucide="party-popper" class="w-12 h-12 text-yellow-500"></i>
                        </div>
                        <div class="text-sm">
                            <p class="text-gray-700">ขอแสดงความยินดีกับคุณ</p>
                            <p id="winner-name" class="font-bold text-lg text-blue-800"></p>
                            <p class="mt-2 text-gray-600">ได้รับรางวัลเป็น</p>
                            <p id="winner-prize" class="font-bold text-xl text-indigo-700"></p>
                        </div>
                        
                        <div id="reward-action-area">
                            <button id="btn-claim-reward" onclick="window.app.claimReward()" class="w-full bg-blue-600 text-white py-3 rounded-lg font-bold hover:bg-blue-700 shadow-md transition-all active:scale-95">
                                ยืนยันการรับรางวัล
                            </button>
                            <p id="reward-claimed-time" class="hidden text-xs text-green-600 font-medium mt-2">
                                <i data-lucide="check" class="inline w-3 h-3"></i> ยืนยันรับรางวัลแล้วเมื่อ:<br><span>-</span>
                            </p>
                        </div>
                    </div>
                </div>
            </div>
            
            <button onclick="window.app.resetForm()" class="w-full bg-blue-600 text-white py-3 rounded-xl font-semibold hover:bg-blue-700 transition shadow-lg shadow-blue-200">
                กลับสู่หน้าหลัก
            </button>
        </div>

        <!-- Error Screen -->
        <div id="screen-error-device" class="hidden bg-white rounded-2xl shadow-xl p-8 max-w-sm w-full text-center animate-fade-in relative z-20">
            <div class="w-20 h-20 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-6">
                <i data-lucide="alert-triangle" class="text-red-600 w-10 h-10"></i>
            </div>
            <h2 class="text-xl font-bold text-red-700 mb-2">ไม่สามารถดำเนินการได้</h2>
            <p id="error-msg-text" class="text-gray-600 mb-6 text-sm">
                เกิดข้อผิดพลาดในการประมวลผล กรุณาลองใหม่อีกครั้ง
            </p>
            
            <button onclick="window.location.reload()" class="w-full bg-gray-200 text-gray-700 py-3 rounded-xl font-semibold hover:bg-gray-300 transition">
                ตกลง
            </button>
        </div>

        <!-- Not Found Screen -->
        <div id="screen-not-found" class="hidden bg-white rounded-2xl shadow-xl p-8 max-w-sm w-full text-center animate-fade-in relative z-20">
            <div class="w-20 h-20 bg-amber-100 rounded-full flex items-center justify-center mx-auto mb-6">
                <i data-lucide="user-x" class="text-amber-600 w-10 h-10"></i>
            </div>
            <h2 class="text-xl font-bold text-amber-700 mb-2">ไม่มีข้อมูลในระบบ</h2>
            <p class="text-gray-600 mb-6 text-sm">
                ไม่พบเลขบัตรประชาชนนี้ในฐานข้อมูล <br/>
                กรุณาตรวจสอบความถูกต้อง
            </p>
            <button onclick="window.app.resetForm()" class="w-full bg-amber-500 text-white py-3 rounded-xl font-semibold hover:bg-amber-600 transition shadow-lg shadow-amber-200">
                ปิด
            </button>
        </div>

        <!-- Footer -->
        <p class="text-center text-gray-400 text-xs mt-8">
            ระบบลงทะเบียนสมาชิกสหกรณ์ <br/>
            © 2024 สหกรณ์ออมทรัพย์พนักงานธนาคารทหารไทย จำกัด
        </p>
    </main>

    <!-- Firebase and Application Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
        import { getFirestore, collection, addDoc, updateDoc, doc, serverTimestamp, query, where, getDocs, onSnapshot } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

        const TARGET_COLLECTION_NAME = 'tmb_coop';
        const isSandboxEnv = typeof __firebase_config !== 'undefined';
        let firebaseConfig;
        let finalCollectionPath;

        if (isSandboxEnv) {
            firebaseConfig = JSON.parse(__firebase_config);
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            finalCollectionPath = `artifacts/${appId}/public/data/coop_registrations`; 
        } else {
            firebaseConfig = {
                apiKey: "AIzaSyAgWMzWcZPzyzoBu5eQzj2y59nKsxTWurQ",
                authDomain: "ttb-register.firebaseapp.com",
                databaseURL: "https://ttb-register-default-rtdb.asia-southeast1.firebasedate.app",
                projectId: "ttb-register",
                storageBucket: "ttb-register.firebasestorage.app",
                messagingSenderId: "1070273157855",
                appId: "1:1070273157855:web:5c8120e1df27e233d8676a",
                measurementId: "G-9DJLWJ5LQ1"
            };
            finalCollectionPath = TARGET_COLLECTION_NAME;
        }

        const state = {
            user: null,
            idCard: '',
            currentDocId: null,
            unsubscribe: null,
            hasFiredFireworks: false
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- Fireworks Function (Updated: Higher zIndex) ---
        function fireCongratulations() {
            const duration = 5 * 1000;
            const animationEnd = Date.now() + duration;
            const defaults = { startVelocity: 30, spread: 360, ticks: 60, zIndex: 10000 };

            function randomInRange(min, max) {
              return Math.random() * (max - min) + min;
            }

            const interval = setInterval(function() {
              const timeLeft = animationEnd - Date.now();

              if (timeLeft <= 0) {
                return clearInterval(interval);
              }

              const particleCount = 50 * (timeLeft / duration);
              confetti(Object.assign({}, defaults, { particleCount, origin: { x: randomInRange(0.1, 0.3), y: Math.random() - 0.2 } }));
              confetti(Object.assign({}, defaults, { particleCount, origin: { x: randomInRange(0.7, 0.9), y: Math.random() - 0.2 } }));
            }, 250);
        }

        async function sha256(message) {
            const msgBuffer = new TextEncoder().encode(message);
            const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            return hashHex;
        }

        function getDeviceId() {
            const STORAGE_KEY = 'coop_device_identifier';
            let deviceId = localStorage.getItem(STORAGE_KEY);
            if (!deviceId) {
                deviceId = 'DEV-' + Date.now().toString(36) + Math.random().toString(36).substr(2, 9);
                localStorage.setItem(STORAGE_KEY, deviceId);
            }
            return deviceId;
        }

        window.app = {
            resetForm: () => {
                if (state.unsubscribe) {
                    state.unsubscribe();
                    state.unsubscribe = null;
                }

                state.hasFiredFireworks = false;

                const screens = ['screen-success', 'screen-error-device', 'screen-not-found'];
                screens.forEach(id => document.getElementById(id).classList.add('hidden'));
                
                document.getElementById('screen-form').classList.remove('hidden');
                document.getElementById('success-user-name').classList.add('hidden');
                
                document.getElementById('reward-waiting').classList.remove('hidden');
                document.getElementById('reward-winner').classList.add('hidden');

                const inputEl = document.getElementById('idCard');
                inputEl.value = '';
                state.idCard = '';
                state.currentDocId = null;
                
                const btn = document.getElementById('btn-submit');
                const btnText = document.getElementById('btn-text');
                const btnLoader = document.getElementById('btn-loader');
                
                btnText.innerText = "ตรวจสอบ / ลงทะเบียน";
                btnLoader.classList.add('hidden');
                btn.disabled = true;
                btn.classList.add('bg-gray-200', 'text-gray-400', 'cursor-not-allowed', 'shadow-none');
                btn.classList.remove('bg-blue-600', 'text-white', 'hover:bg-blue-700', 'shadow-blue-200');

                const icon = document.getElementById('icon-check-valid');
                icon.classList.add('hidden');
                inputEl.classList.remove('border-blue-500', 'bg-blue-50/30');
                inputEl.classList.add('border-gray-200', 'bg-white');

                inputEl.focus();
            },

            claimReward: async () => {
                if (!state.currentDocId) return;
                const btn = document.getElementById('btn-claim-reward');
                btn.disabled = true;
                btn.innerText = "กำลังบันทึก...";

                try {
                    await updateDoc(doc(db, finalCollectionPath, state.currentDocId), {
                        ConfirmReward: serverTimestamp()
                    });
                } catch (e) {
                    console.error("Claim reward error:", e);
                    btn.disabled = false;
                    btn.innerText = "ยืนยันการรับรางวัล (ลองใหม่)";
                }
            }
        };

        function startRewardListener(docId) {
            if (state.unsubscribe) state.unsubscribe();
            
            state.unsubscribe = onSnapshot(doc(db, finalCollectionPath, docId), (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    const rewardWaiting = document.getElementById('reward-waiting');
                    const rewardWinner = document.getElementById('reward-winner');
                    
                    if (data.reward) {
                        rewardWaiting.classList.add('hidden');
                        rewardWinner.classList.remove('hidden');
                        document.getElementById('winner-name').innerText = data.EmpName || 'สมาชิก';
                        document.getElementById('winner-prize').innerText = data.reward;
                        
                        const claimBtn = document.getElementById('btn-claim-reward');
                        const claimTimeText = document.getElementById('reward-claimed-time');
                        
                        // Fire fireworks when reward is first detected
                        if (!state.hasFiredFireworks) {
                            fireCongratulations();
                            state.hasFiredFireworks = true;
                        }

                        if (data.ConfirmReward) {
                            claimBtn.classList.add('hidden');
                            claimTimeText.classList.remove('hidden');
                            const ts = data.ConfirmReward.toDate ? data.ConfirmReward.toDate() : new Date(data.ConfirmReward);
                            claimTimeText.querySelector('span').innerText = ts.toLocaleString('th-TH');
                        } else {
                            claimBtn.classList.remove('hidden');
                            claimBtn.disabled = false;
                            claimBtn.innerText = "ยืนยันการรับรางวัล";
                            claimTimeText.classList.add('hidden');
                        }
                    } else {
                        rewardWaiting.classList.remove('hidden');
                        rewardWinner.classList.add('hidden');
                    }
                }
            }, (error) => {
                console.error("Listener error:", error);
            });
        }

        function updateSuccessUI(checkInStr, isNew, empName, docId) {
            document.getElementById('success-title').innerText = isNew ? "ลงทะเบียนสำเร็จ" : "ท่านได้ลงทะเบียนไปแล้ว";
            document.getElementById('success-checkin-datetime').innerText = "ลงทะเบียนเมื่อ: " + checkInStr;
            
            const nameEl = document.getElementById('success-user-name');
            if (empName) {
                nameEl.innerText = empName;
                nameEl.classList.remove('hidden');
            } else {
                nameEl.classList.add('hidden');
            }

            document.getElementById('screen-form').classList.add('hidden');
            document.getElementById('screen-success').classList.remove('hidden');

            // Immediately check for reward and setup listener
            startRewardListener(docId);
        }

        async function initAuth() {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (e) {
                console.error("Auth failed", e);
            }
        }

        onAuthStateChanged(auth, (user) => { state.user = user; });

        function handleIdInput(e) {
            let raw = e.target.value.replace(/[^0-9]/g, '');
            if (raw.length > 13) raw = raw.slice(0, 13);

            let formatted = raw;
            if (raw.length > 1) formatted = raw.slice(0, 1) + '-' + raw.slice(1);
            if (raw.length > 5) formatted = formatted.slice(0, 6) + '-' + formatted.slice(6);
            if (raw.length > 10) formatted = formatted.slice(0, 12) + '-' + formatted.slice(12);
            if (raw.length > 12) formatted = formatted.slice(0, 15) + '-' + formatted.slice(15);

            state.idCard = formatted;
            document.getElementById('idCard').value = formatted;

            const icon = document.getElementById('icon-check-valid');
            const inputEl = document.getElementById('idCard');

            if (raw.length === 13) {
                 inputEl.classList.add('border-blue-500', 'bg-blue-50/30');
                 inputEl.classList.remove('border-gray-200', 'bg-white');
                 icon.classList.remove('hidden');
            } else {
                 inputEl.classList.remove('border-blue-500', 'bg-blue-50/30');
                 inputEl.classList.add('border-gray-200', 'bg-white');
                 icon.classList.add('hidden');
            }
            validateForm();
        }

        function validateForm() {
            const rawId = state.idCard.replace(/-/g, '');
            const isIdValid = rawId.length === 13;
            const btn = document.getElementById('btn-submit');
            if (isIdValid) {
                btn.disabled = false;
                btn.classList.remove('bg-gray-200', 'text-gray-400', 'cursor-not-allowed', 'shadow-none');
                btn.classList.add('bg-blue-600', 'text-white', 'hover:bg-blue-700', 'shadow-blue-200');
            } else {
                btn.disabled = true;
                btn.classList.add('bg-gray-200', 'text-gray-400', 'cursor-not-allowed', 'shadow-none');
                btn.classList.remove('bg-blue-600', 'text-white', 'hover:bg-blue-700', 'shadow-blue-200');
            }
        }

        async function submitForm(e) {
            e.preventDefault();
            if (!state.user) return;

            const btn = document.getElementById('btn-submit');
            const btnText = document.getElementById('btn-text');
            const btnLoader = document.getElementById('btn-loader');
            btn.disabled = true;
            btnText.innerText = "กำลังตรวจสอบ...";
            btnLoader.classList.remove('hidden');

            try {
                const currentDeviceId = getDeviceId();
                const rawId = state.idCard.replace(/-/g, '');
                const hashId = await sha256(rawId);

                const userQuery = query(
                    collection(db, finalCollectionPath), 
                    where("citizenId", "==", hashId)
                );
                const userSnapshot = await getDocs(userQuery);

                if (!userSnapshot.empty) {
                    const userDoc = userSnapshot.docs[0];
                    const userData = userDoc.data();
                    state.currentDocId = userDoc.id;
                    
                    const updatePayload = {};
                    let performUpdate = false;

                    if (userData.deviceId !== currentDeviceId) {
                        updatePayload.deviceId = currentDeviceId;
                        performUpdate = true;
                    }

                    let timeStr = "";
                    let isNewRegistration = false;
                    const isCheckInMissing = !userData.CheckIN;

                    if (isCheckInMissing) {
                        updatePayload.CheckIN = serverTimestamp();
                        updatePayload.status = 'checked-in';
                        isNewRegistration = true;
                        performUpdate = true;
                        const now = new Date();
                        timeStr = now.toLocaleDateString('th-TH') + ' ' + now.toLocaleTimeString('th-TH');
                    } else {
                        const timestamp = userData.CheckIN.toDate ? userData.CheckIN.toDate() : new Date(userData.CheckIN);
                        timeStr = timestamp.toLocaleDateString('th-TH') + ' ' + timestamp.toLocaleTimeString('th-TH');
                    }

                    if (performUpdate) {
                        await updateDoc(doc(db, finalCollectionPath, userDoc.id), updatePayload);
                    }

                    updateSuccessUI(timeStr, isNewRegistration, userData.EmpName, userDoc.id);

                } else {
                    const newDoc = await addDoc(collection(db, finalCollectionPath), {
                        citizenId: hashId,
                        deviceId: currentDeviceId,
                        CheckIN: serverTimestamp(),
                        status: 'checked-in'
                    });
                    
                    state.currentDocId = newDoc.id;
                    const now = new Date();
                    const timeStr = now.toLocaleDateString('th-TH') + ' ' + now.toLocaleTimeString('th-TH');
                    updateSuccessUI(timeStr, true, null, newDoc.id);
                }

            } catch (error) {
                console.error("Submit Error:", error);
                document.getElementById('error-msg-text').innerHTML = `เกิดข้อผิดพลาดในการส่งข้อมูล: ${error.message}`;
                document.getElementById('screen-form').classList.add('hidden');
                document.getElementById('screen-error-device').classList.remove('hidden');
            } finally {
                btn.disabled = false;
                btnText.innerText = "ตรวจสอบ / ลงทะเบียน";
                btnLoader.classList.add('hidden');
                validateForm();
            }
        }

        // --- Run ---
        document.getElementById('registration-form').addEventListener('submit', submitForm);
        document.getElementById('idCard').addEventListener('input', handleIdInput);
        
        window.addEventListener('load', () => {
            document.getElementById('idCard').focus();
        });

        initAuth();
        if (window.lucide) lucide.createIcons();

    </script>
</body>
</html>